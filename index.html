<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>my blog test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="我是description">
<meta property="og:type" content="website">
<meta property="og:title" content="my blog test">
<meta property="og:url" content="http://codershmily.github.io/index.html">
<meta property="og:site_name" content="my blog test">
<meta property="og:description" content="我是description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="my blog test">
<meta name="twitter:description" content="我是description">
  
    <link rel="alternate" href="/atom.xml" title="my blog test" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">my blog test</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">我是subtitle</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">所有文章</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codershmily.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2015-05-15-sdwebimageyuan-ma-jie-xi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/15/2015-05-15-sdwebimageyuan-ma-jie-xi/" class="article-date">
  <time datetime="2015-05-15T00:11:01.000Z" itemprop="datePublished">2015-05-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/15/2015-05-15-sdwebimageyuan-ma-jie-xi/">SDWebImage源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * This file is part of the SDWebImage package.</div><div class="line"> * (c) Olivier Poitrey &lt;rs@dailymotion.com&gt;</div><div class="line"> *</div><div class="line"> * For the full copyright and license information, please view the LICENSE</div><div class="line"> * file that was distributed with this source code.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"SDWebImageCompat.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"SDWebImageOperation.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"SDWebImageDownloader.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"SDImageCache.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, SDWebImageOptions) &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * By default, when a URL fail to be downloaded, the URL is blacklisted so the library won't keep trying.</div><div class="line">     * This flag disable this blacklisting.</div><div class="line">     */</div><div class="line">    <span class="comment">/**</span></div><div class="line">     *默认情况下,如果一个url在下载的时候失败了,那么这个url会被加入黑名单并且library不会尝试再次下载,这个flag会阻止library把失败的url加入黑名单(简单来说如果选择了这个flag,那么即使某个url下载失败了,sdwebimage还是会尝试再次下载他.)</div><div class="line">     */</div><div class="line">    SDWebImageRetryFailed = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * By default, image downloads are started during UI interactions, this flags disable this feature,</div><div class="line">     * leading to delayed download on UIScrollView deceleration for instance.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     *默认情况下,图片会在交互发生的时候下载(例如你滑动tableview的时候),这个flag会禁止这个特性,导致的结果就是在scrollview减速的时候</div><div class="line">     *才会开始下载(也就是你滑动的时候scrollview不下载,你手从屏幕上移走,scrollview开始减速的时候才会开始下载图片)</div><div class="line">     */</div><div class="line">    SDWebImageLowPriority = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This flag disables on-disk caching</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *这个flag禁止磁盘缓存,只有内存缓存</div><div class="line">     */</div><div class="line">    SDWebImageCacheMemoryOnly = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This flag enables progressive download, the image is displayed progressively during download as a browser would do.</div><div class="line">     * By default, the image is only displayed once completely downloaded.</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *这个flag会在图片下载的时候就显示(就像你用浏览器浏览网页的时候那种图片下载,一截一截的显示(待确认))</div><div class="line">     *</div><div class="line">     */</div><div class="line">    SDWebImageProgressiveDownload = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Even if the image is cached, respect the HTTP response cache control, and refresh the image from remote location if needed.</div><div class="line">     * The disk caching will be handled by NSURLCache instead of SDWebImage leading to slight performance degradation.</div><div class="line">     * This option helps deal with images changing behind the same request URL, e.g. Facebook graph api profile pics.</div><div class="line">     * If a cached image is refreshed, the completion block is called once with the cached image and again with the final image.</div><div class="line">     *</div><div class="line">     * Use this flag only if you can't make your URLs static with embeded cache busting parameter.</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *这个选项的意思看的不是很懂,大意是即使一个图片缓存了,还是会重新请求.并且缓存侧略依据NSURLCache而不是SDWebImage.</div><div class="line">     *</div><div class="line">     */</div><div class="line">    SDWebImageRefreshCached = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * In iOS 4+, continue the download of the image if the app goes to background. This is achieved by asking the system for</div><div class="line">     * extra time in background to let the request finish. If the background task expires the operation will be cancelled.</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *启动后台下载,加入你进入一个页面,有一张图片正在下载这时候你让app进入后台,图片还是会继续下载(这个估计要开backgroundfetch才有用)</div><div class="line">     */</div><div class="line">    SDWebImageContinueInBackground = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handles cookies stored in NSHTTPCookieStore by setting</div><div class="line">     * NSMutableURLRequest.HTTPShouldHandleCookies = YES;</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *可以控制存在NSHTTPCookieStore的cookies.(我没用过,等用过的人过来解释一下)</div><div class="line">     */</div><div class="line">    SDWebImageHandleCookies = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Enable to allow untrusted SSL ceriticates.</div><div class="line">     * Useful for testing purposes. Use with caution in production.</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *允许不安全的SSL证书,在正式环境中慎用</div><div class="line">     */</div><div class="line">    SDWebImageAllowInvalidSSLCertificates = <span class="number">1</span> &lt;&lt; <span class="number">7</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * By default, image are loaded in the order they were queued. This flag move them to</div><div class="line">     * the front of the queue and is loaded immediately instead of waiting for the current queue to be loaded (which </div><div class="line">     * could take a while).</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *默认情况下,image在装载的时候是按照他们在队列中的顺序装载的(就是先进先出).这个flag会把他们移动到队列的前端,并且立刻装载</div><div class="line">     *而不是等到当前队列装载的时候再装载.</div><div class="line">     */</div><div class="line">    SDWebImageHighPriority = <span class="number">1</span> &lt;&lt; <span class="number">8</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * By default, placeholder images are loaded while the image is loading. This flag will delay the loading</div><div class="line">     * of the placeholder image until after the image has finished loading.</div><div class="line">     */</div><div class="line">    <span class="comment">/*</span></div><div class="line">     *默认情况下,占位图会在图片下载的时候显示.这个flag开启会延迟占位图显示的时间,等到图片下载完成之后才会显示占位图.(等图片显示完了我干嘛还显示占位图?或许是我理解错了?)</div><div class="line">     */</div><div class="line">    SDWebImageDelayPlaceholder = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * We usually don't call transformDownloadedImage delegate method on animated images,</div><div class="line">     * as most transformation code would mangle it.</div><div class="line">     * Use this flag to transform them anyway.</div><div class="line">     */</div><div class="line">    <span class="comment">/* </span></div><div class="line">     *是否transform图片(没用过,还要再看,但是据我估计,是否是图片有可能方向不对需要调整方向,例如采用iPhone拍摄的照片如果不纠正方向,那么图片是向左旋转90度的.可能很多人不知道iPhone的摄像头并不是竖直的,而是向左偏了90度.具体请google.)</div><div class="line">     */</div><div class="line">    SDWebImageTransformAnimatedImage = <span class="number">1</span> &lt;&lt; <span class="number">10</span>,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^SDWebImageCompletionBlock)(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">NSURL</span> *imageURL);</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^SDWebImageCompletionWithFinishedBlock)(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL);</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NSString</span> *(^SDWebImageCacheKeyFilterBlock)(<span class="built_in">NSURL</span> *url);</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@class</span> <span class="title">SDWebImageManager</span>;</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">SDWebImageManagerDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@optional</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Controls which image should be downloaded when the image is not found in the cache.</div><div class="line"> *</div><div class="line"> * @param imageManager The current `SDWebImageManager`</div><div class="line"> * @param imageURL     The url of the image to be downloaded</div><div class="line"> *</div><div class="line"> * @return Return NO to prevent the downloading of the image on cache misses. If not implemented, YES is implied.</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> *主要作用是当缓存里没有发现某张图片的缓存时,是否选择下载这张图片(默认是yes),可以选择no,那么sdwebimage在缓存中没有找到这张图片的时候不会选择下载</div><div class="line"> */</div><div class="line">- (<span class="built_in">BOOL</span>)imageManager:(SDWebImageManager *)imageManager shouldDownloadImageForURL:(<span class="built_in">NSURL</span> *)imageURL;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Allows to transform the image immediately after it has been downloaded and just before to cache it on disk and memory.</div><div class="line"> * <span class="doctag">NOTE:</span> This method is called from a global queue in order to not to block the main thread.</div><div class="line"> *</div><div class="line"> * @param imageManager The current `SDWebImageManager`</div><div class="line"> * @param image        The image to transform</div><div class="line"> * @param imageURL     The url of the image to transform</div><div class="line"> *</div><div class="line"> * @return The transformed image object.</div><div class="line"> */</div><div class="line"><span class="comment">/**</span></div><div class="line"> *在图片下载完成并且还没有加入磁盘缓存或者内存缓存的时候就transform这个图片.这个方法是在异步线程执行的,防治阻塞主线程.</div><div class="line"> *至于为什么在异步执行很简单,对一张图片纠正方向(也就是transform)是很耗资源的,一张2M大小的图片纠正方向你可以用instrument测试一下耗时.</div><div class="line"> *很恐怖</div><div class="line"> */</div><div class="line">- (<span class="built_in">UIImage</span> *)imageManager:(SDWebImageManager *)imageManager transformDownloadedImage:(<span class="built_in">UIImage</span> *)image withURL:(<span class="built_in">NSURL</span> *)imageURL;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * The SDWebImageManager is the class behind the UIImageView+WebCache category and likes.</div><div class="line"> * It ties the asynchronous downloader (SDWebImageDownloader) with the image cache store (SDImageCache).</div><div class="line"> * You can use this class directly to benefit from web image downloading with caching in another context than</div><div class="line"> * a UIView.</div><div class="line"> *</div><div class="line"> * Here is a simple example of how to use SDWebImageManager:</div><div class="line"> *</div><div class="line"> * @code</div><div class="line"></div><div class="line">SDWebImageManager *manager = [SDWebImageManager sharedManager];</div><div class="line">[manager downloadImageWithURL:imageURL</div><div class="line">                      options:0</div><div class="line">                     progress:nil</div><div class="line">                    completed:^(UIImage *image, NSError *error, SDImageCacheType cacheType, BOOL finished, NSURL *imageURL) &#123;</div><div class="line">                        if (image) &#123;</div><div class="line">                            // do something with image</div><div class="line">                        &#125;</div><div class="line">                    &#125;];</div><div class="line"></div><div class="line"> * @endcode</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> *这一段是阐述SDWebImageManager是干嘛的.其实UIImageView+WebCache这个category背后执行操作的就是这个SDWebImageManager.他会绑定一个下载器也就是SDWebImageDownloader和一个缓存SDImageCache.后面的大意应该是讲你可以直接使用一个其他上下文环境的SDWebImageManager,而不是仅仅限于一个UIView.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDWebImageManager</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">id</span> &lt;SDWebImageManagerDelegate&gt; delegate;</div><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line"> *如同上文所说,一个SDWebImageManager会绑定一个imageCache和一个下载器.</div><div class="line"> */</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) SDImageCache *imageCache;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) SDWebImageDownloader *imageDownloader;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * The cache filter is a block used each time SDWebImageManager need to convert an URL into a cache key. This can</div><div class="line"> * be used to remove dynamic part of an image URL.</div><div class="line"> *</div><div class="line"> * The following example sets a filter in the application delegate that will remove any query-string from the</div><div class="line"> * URL before to use it as a cache key:</div><div class="line"> *</div><div class="line"> * @code</div><div class="line"></div><div class="line">[[SDWebImageManager sharedManager] setCacheKeyFilter:^(NSURL *url) &#123;</div><div class="line">    url = [[NSURL alloc] initWithScheme:url.scheme host:url.host path:url.path];</div><div class="line">    return [url absoluteString];</div><div class="line">&#125;];</div><div class="line"></div><div class="line"> * @endcode</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * 这个cacheKeyFilter是干嘛的呢?很简单.1他是一个block.2.这个block的作用就是生成一个image的key.因为sdwebimage的缓存原理你可以当成是一个字典,每一个字典的value就是一张image,那么这个value对应的key是什么呢?就是cacheKeyFilter根据某个规则对这个图片的url做一些操作生成的.上面的示例就显示了怎么利用这个block把image的url重新组合生成一个key.以后当sdwebimage检测到你</div><div class="line"> */</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) SDWebImageCacheKeyFilterBlock cacheKeyFilter;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns global SDWebImageManager instance.</div><div class="line"> *</div><div class="line"> * @return SDWebImageManager shared instance</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> *这个不用我解释了吧,生成一个SDWebImagemanager的单例.</div><div class="line"> */</div><div class="line">+ (SDWebImageManager *)sharedManager;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Downloads the image at the given URL if not present in cache or return the cached version otherwise.</div><div class="line"> * 从给定的URL中下载一个之前没有被缓存的Image.</div><div class="line"> *</div><div class="line"> * @param url            The URL to the image</div><div class="line"> * @param options        A mask to specify options to use for this request</div><div class="line"> * @param progressBlock  A block called while image is downloading</div><div class="line"> * @param completedBlock A block called when operation has been completed.</div><div class="line"> *</div><div class="line"> *   This parameter is required.</div><div class="line"> * </div><div class="line"> *   This block has no return value and takes the requested UIImage as first parameter.</div><div class="line"> *   In case of error the image parameter is nil and the second parameter may contain an NSError.</div><div class="line"> *</div><div class="line"> *   The third parameter is an `SDImageCacheType` enum indicating if the image was retrived from the local cache</div><div class="line"> *   or from the memory cache or from the network.</div><div class="line"> *</div><div class="line"> *   The last parameter is set to NO when the SDWebImageProgressiveDownload option is used and the image is </div><div class="line"> *   downloading. This block is thus called repetidly with a partial image. When image is fully downloaded, the</div><div class="line"> *   block is called a last time with the full image and the last parameter set to YES.</div><div class="line"> *</div><div class="line"> * @return Returns an NSObject conforming to SDWebImageOperation. Should be an instance of SDWebImageDownloaderOperation</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * 这个方法主要就是SDWebImage下载图片的方法了.  </div><div class="line"> * 第一个参数是必须要的,就是image的url</div><div class="line"> * 第二个参数就是我们上面的Options,你可以定制化各种各样的操作.详情参上. </div><div class="line"> * 第三个参数是一个回调block,用于图片在下载过程中的回调.(英文注释应该是有问题的.)</div><div class="line"> * 第四个参数是一个下载完成的回调.会在图片下载完成后回调.</div><div class="line"> * 返回值是一个NSObject类,并且这个NSObject类是conforming一个协议这个协议叫做SDWebImageOperation,这个协议很简单,就是一个cancel掉operation的协议.</div><div class="line"> */</div><div class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                                         options:(SDWebImageOptions)options</div><div class="line">                                        progress:(SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                                       completed:(SDWebImageCompletionWithFinishedBlock)completedBlock;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Saves image to cache for given URL</div><div class="line"> *</div><div class="line"> * @param image The image to cache</div><div class="line"> * @param url   The URL to the image</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * 将图片存入cache的方法,类似于字典的setValue: forKey:</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)saveImageToCache:(<span class="built_in">UIImage</span> *)image forURL:(<span class="built_in">NSURL</span> *)url;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Cancel all current opreations</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> *取消掉当前所有的下载图片的operation</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)cancelAll;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Check one or more operations running</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * check一下是否有一个或者多个operation正在执行(简单来说就是check是否有图片在下载)</div><div class="line"> */</div><div class="line">- (<span class="built_in">BOOL</span>)isRunning;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  Check if image has already been cached</div><div class="line"> *</div><div class="line"> *  @param url image url</div><div class="line"> *</div><div class="line"> *  @return if the image was already cached</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * 通过一个image的url是否已经存在,如果存在返回yes,否则返回no</div><div class="line"> */</div><div class="line">- (<span class="built_in">BOOL</span>)cachedImageExistsForURL:(<span class="built_in">NSURL</span> *)url;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  Check if image has already been cached on disk only</div><div class="line"> *</div><div class="line"> *  @param url image url</div><div class="line"> *</div><div class="line"> *  @return if the image was already cached (disk only)</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * 检测一个image是否已经被缓存到磁盘(是否存且仅存在disk里).</div><div class="line"> */</div><div class="line">- (<span class="built_in">BOOL</span>)diskImageExistsForURL:(<span class="built_in">NSURL</span> *)url;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  Async check if image has already been cached</div><div class="line"> *</div><div class="line"> *  @param url              image url</div><div class="line"> *  @param completionBlock  the block to be executed when the check is finished</div><div class="line"> *  </div><div class="line"> *  @note the completion block is always executed on the main queue</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * 如果检测到图片已经被缓存,那么执行回调block.这个block会永远执行在主线程.也就是你可以在这个回调block里更新ui.</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)cachedImageExistsForURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                     completion:(SDWebImageCheckCacheCompletionBlock)completionBlock;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  Async check if image has already been cached on disk only</div><div class="line"> *</div><div class="line"> *  @param url              image url</div><div class="line"> *  @param completionBlock  the block to be executed when the check is finished</div><div class="line"> *</div><div class="line"> *  @note the completion block is always executed on the main queue</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * 如果检测到图片已经被缓存在磁盘(存且仅存在disk),那么执行回调block.这个block会永远执行在主线程.也就是你可以在这个回调block里更新ui.</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)diskImageExistsForURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                   completion:(SDWebImageCheckCacheCompletionBlock)completionBlock;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *Return the cache key for a given URL</div><div class="line"> */</div><div class="line"><span class="comment">/*</span></div><div class="line"> * 通过image的url返回image存在缓存里的key.有人会问了,为什么不直接把图片的url当做image的key来使用呢?而是非要对url做一些处理才能当做key.我的解释是,我也不太清楚.可能为了防止重复吧.</div><div class="line"> */</div><div class="line">- (<span class="built_in">NSString</span> *)cacheKeyForURL:(<span class="built_in">NSURL</span> *)url;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#pragma mark - Deprecated</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^SDWebImageCompletedBlock)(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType) __deprecated_msg(<span class="string">"Block type deprecated. Use `SDWebImageCompletionBlock`"</span>);</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^SDWebImageCompletedWithFinishedBlock)(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished) __deprecated_msg(<span class="string">"Block type deprecated. Use `SDWebImageCompletionWithFinishedBlock`"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 已被废弃</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDWebImageManager</span> (<span class="title">Deprecated</span>)</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  Downloads the image at the given URL if not present in cache or return the cached version otherwise.</div><div class="line"> *</div><div class="line"> *  @deprecated This method has been deprecated. Use `downloadImageWithURL:options:progress:completed:`</div><div class="line"> */</div><div class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadWithURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                                    options:(SDWebImageOptions)options</div><div class="line">                                   progress:(SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                                  completed:(SDWebImageCompletedWithFinishedBlock)completedBlock __deprecated_msg(<span class="string">"Method deprecated. Use `downloadImageWithURL:options:progress:completed:`"</span>);</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line"> * This file is part of the SDWebImage package.</div><div class="line"> *</div><div class="line"> * For the full copyright and license information, please view the LICENSE</div><div class="line"> * file that was distributed with this source code.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"SDWebImageManager.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">// 内部类.</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDWebImageCombinedOperation</span> : <span class="title">NSObject</span> &lt;<span class="title">SDWebImageOperation</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>, <span class="keyword">getter</span> = isCancelled) <span class="built_in">BOOL</span> cancelled;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">nonatomic</span>) SDWebImageNoParamsBlock cancelBlock;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSOperation</span> *cacheOperation;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDWebImageManager</span> ()</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>) SDImageCache *imageCache;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>) SDWebImageDownloader *imageDownloader;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableSet</span> *failedURLs;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span> *runningOperations;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SDWebImageManager</span></span></div><div class="line"></div><div class="line"><span class="comment">// 利用disptach_once 特性生成一个单例,用烂了的方法.不赘述.</span></div><div class="line">+ (<span class="keyword">id</span>)sharedManager &#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> once;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">id</span> instance;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;once, ^&#123;</div><div class="line">        instance = [<span class="keyword">self</span> new];</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> instance;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化方法.</span></div><div class="line"><span class="comment">// 1.获得一个SDImageCache的单例.2.获取一个SDWebImageDownloader的单例.3.新建一个MutableSet来存储下载失败的url.</span></div><div class="line"><span class="comment">// 4.新建一个用来存储下载operation的可变数组.</span></div><div class="line"><span class="comment">// 为什么不用MutableArray储存下载失败的URL?</span></div><div class="line"><span class="comment">// 因为NSSet类有一个特性,就是Hash.实际上NSSet是一个哈希表,哈希表比数组优秀的地方是什么呢?就是查找速度快.查找同样一个元素,哈希表只需要通过key</span></div><div class="line"><span class="comment">// 即可取到,而数组至少需要遍历依次.因为SDWebImage里有关失败URL的业务需求是,一个失败的URL只需要储存一次.这样的话Set自然比Array更合适.</span></div><div class="line">- (<span class="keyword">id</span>)init &#123;</div><div class="line">    <span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</div><div class="line">        _imageCache = [<span class="keyword">self</span> createCache];</div><div class="line">        _imageDownloader = [SDWebImageDownloader sharedDownloader];</div><div class="line">        _failedURLs = [<span class="built_in">NSMutableSet</span> new];</div><div class="line">        _runningOperations = [<span class="built_in">NSMutableArray</span> new];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 获取一个cache的单例</span></div><div class="line">- (SDImageCache *)createCache &#123;</div><div class="line">    <span class="keyword">return</span> [SDImageCache sharedImageCache];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 利用Image的URL生成一个缓存时需要的key.</span></div><div class="line"><span class="comment">// 这里有两种情况,第一种是如果检测到cacheKeyFilter不为空时,利用cacheKeyFilter来处理URL生成一个key.</span></div><div class="line"><span class="comment">// 如果为空,那么直接返回URL的string内容,当做key.</span></div><div class="line">- (<span class="built_in">NSString</span> *)cacheKeyForURL:(<span class="built_in">NSURL</span> *)url &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.cacheKeyFilter) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.cacheKeyFilter(url);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> [url absoluteString];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 检测一张图片是否已被缓存.</span></div><div class="line"><span class="comment">// 首先检测内存缓存是否存在这张图片,如果已有,直接返回yes.</span></div><div class="line"><span class="comment">// 如果内存缓存里没有这张图片,那么调用diskImageExistsWithKey这个方法去硬盘缓存里找</span></div><div class="line">- (<span class="built_in">BOOL</span>)cachedImageExistsForURL:(<span class="built_in">NSURL</span> *)url &#123;</div><div class="line">    <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.imageCache imageFromMemoryCacheForKey:key] != <span class="literal">nil</span>) <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.imageCache diskImageExistsWithKey:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 检测硬盘里是否缓存了图片</span></div><div class="line">- (<span class="built_in">BOOL</span>)diskImageExistsForURL:(<span class="built_in">NSURL</span> *)url &#123;</div><div class="line">    <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.imageCache diskImageExistsWithKey:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 首先生成一个用来cache 住Image的key(利用key的url生成)</span></div><div class="line"><span class="comment">// 然后检测内存缓存里是否已经有这张图片</span></div><div class="line"><span class="comment">// 如果已经被缓存,那么再主线程里回调block</span></div><div class="line"><span class="comment">// 如果没有检测到,那么调用diskImageExistsWithKey,这个方法会在异步线程里,将图片存到硬盘,当然在存图之前也会检测是否已在硬盘缓存图片.</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)cachedImageExistsForURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                     completion:(SDWebImageCheckCacheCompletionBlock)completionBlock &#123;</div><div class="line">    <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</div><div class="line">    </div><div class="line">    <span class="built_in">BOOL</span> isInMemoryCache = ([<span class="keyword">self</span>.imageCache imageFromMemoryCacheForKey:key] != <span class="literal">nil</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (isInMemoryCache) &#123;</div><div class="line">        <span class="comment">// making sure we call the completion block on the main queue</span></div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">            <span class="keyword">if</span> (completionBlock) &#123;</div><div class="line">                completionBlock(<span class="literal">YES</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.imageCache diskImageExistsWithKey:key completion:^(<span class="built_in">BOOL</span> isInDiskCache) &#123;</div><div class="line">        <span class="comment">// the completion block of checkDiskCacheForImageWithKey:completion: is always called on the main queue, no need to further dispatch</span></div><div class="line">        <span class="keyword">if</span> (completionBlock) &#123;</div><div class="line">            completionBlock(isInDiskCache);</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//将图片存入硬盘</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)diskImageExistsForURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                   completion:(SDWebImageCheckCacheCompletionBlock)completionBlock &#123;</div><div class="line">    <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.imageCache diskImageExistsWithKey:key completion:^(<span class="built_in">BOOL</span> isInDiskCache) &#123;</div><div class="line">        <span class="comment">// the completion block of checkDiskCacheForImageWithKey:completion: is always called on the main queue, no need to further dispatch</span></div><div class="line">        <span class="keyword">if</span> (completionBlock) &#123;</div><div class="line">            completionBlock(isInDiskCache);</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 通过url建立一个operation用来下载图片.</span></div><div class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                                         options:(SDWebImageOptions)options</div><div class="line">                                        progress:(SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                                       completed:(SDWebImageCompletionWithFinishedBlock)completedBlock &#123;</div><div class="line">    <span class="comment">// Invoking this method without a completedBlock is pointless</span></div><div class="line">    <span class="built_in">NSAssert</span>(completedBlock != <span class="literal">nil</span>, <span class="string">@"If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead"</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// Very common mistake is to send the URL using NSString object instead of NSURL. For some strange reason, XCode won't</span></div><div class="line">    <span class="comment">// throw any warning for this type mismatch. Here we failsafe this error by allowing URLs to be passed as NSString.</span></div><div class="line">    <span class="keyword">if</span> ([url isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</div><div class="line">        url = [<span class="built_in">NSURL</span> URLWithString:(<span class="built_in">NSString</span> *)url];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Prevents app crashing on argument type error like sending NSNull instead of NSURL</span></div><div class="line">    <span class="keyword">if</span> (![url isKindOfClass:<span class="built_in">NSURL</span>.class]) &#123;</div><div class="line">        url = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];</div><div class="line">    __<span class="keyword">weak</span> SDWebImageCombinedOperation *weakOperation = operation;</div><div class="line">    </div><div class="line">    <span class="built_in">BOOL</span> isFailedUrl = <span class="literal">NO</span>;</div><div class="line">    <span class="comment">// 创建一个互斥锁防止现在有别的线程修改failedURLs.</span></div><div class="line">    <span class="comment">// 判断这个url是否是fail过的.如果url failed过的那么isFailedUrl就是true</span></div><div class="line">    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.failedURLs) &#123;</div><div class="line">        isFailedUrl = [<span class="keyword">self</span>.failedURLs containsObject:url];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果url不存在那么直接返回一个block,如果url存在.那么继续进行判断.</span></div><div class="line">    <span class="comment">// options与SDWebImageRetryFailed这个option进行按位与操作.判断用户的options里是否有retry这个option.</span></div><div class="line">    <span class="comment">// 如果用户的options里没有retry这个选项并且isFaileUrl 是true.那么就回调一个error的block.</span></div><div class="line">    <span class="keyword">if</span> (!url || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</div><div class="line">        dispatch_main_sync_safe(^&#123;</div><div class="line">            <span class="built_in">NSError</span> *error = [<span class="built_in">NSError</span> errorWithDomain:<span class="built_in">NSURLErrorDomain</span> code:<span class="built_in">NSURLErrorFileDoesNotExist</span> userInfo:<span class="literal">nil</span>];</div><div class="line">            completedBlock(<span class="literal">nil</span>, error, SDImageCacheTypeNone, <span class="literal">YES</span>, url);</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> operation;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 创建一个互斥锁防止现在有别的线程修改runningOperations.</span></div><div class="line">    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</div><div class="line">        [<span class="keyword">self</span>.runningOperations addObject:operation];</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</div><div class="line">    </div><div class="line">    <span class="comment">// cacheOperation应该是一个用来下载图片并且缓存的operation</span></div><div class="line">    operation.cacheOperation = [<span class="keyword">self</span>.imageCache queryDiskCacheForKey:key done:^(<span class="built_in">UIImage</span> *image, SDImageCacheType cacheType) &#123;</div><div class="line">        <span class="comment">// 判断operation这时候有没有执行cancel操作,如果cancel掉了就把这个operation从我们的operation数组里remove掉然后return</span></div><div class="line">        <span class="keyword">if</span> (operation.isCancelled) &#123;</div><div class="line">            <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</div><div class="line">                [<span class="keyword">self</span>.runningOperations removeObject:operation];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> ((!image || options &amp; SDWebImageRefreshCached) &amp;&amp; (![<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(imageManager:shouldDownloadImageForURL:)] || [<span class="keyword">self</span>.delegate imageManager:<span class="keyword">self</span> shouldDownloadImageForURL:url])) &#123;</div><div class="line">            <span class="keyword">if</span> (image &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</div><div class="line">                dispatch_main_sync_safe(^&#123;</div><div class="line">                    <span class="comment">// If image was found in the cache bug SDWebImageRefreshCached is provided, notify about the cached image</span></div><div class="line">                    <span class="comment">// AND try to re-download it in order to let a chance to NSURLCache to refresh it from server.</span></div><div class="line">                    completedBlock(image, <span class="literal">nil</span>, cacheType, <span class="literal">YES</span>, url);</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// download if no image or requested to refresh anyway, and download allowed by delegate</span></div><div class="line">            <span class="comment">// 下面都是判断我们的options里包含哪些SDWebImageOptions,然后给我们的downloaderOptions相应的添加对应的SDWebImageDownloaderOptions. downloaderOptions |= SDWebImageDownloaderLowPriority这种表达式的意思等同于</span></div><div class="line">            <span class="comment">// downloaderOptions = downloaderOptions | SDWebImageDownloaderLowPriority</span></div><div class="line">            SDWebImageDownloaderOptions downloaderOptions = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (options &amp; SDWebImageLowPriority) downloaderOptions |= SDWebImageDownloaderLowPriority;</div><div class="line">            <span class="keyword">if</span> (options &amp; SDWebImageProgressiveDownload) downloaderOptions |= SDWebImageDownloaderProgressiveDownload;</div><div class="line">            <span class="keyword">if</span> (options &amp; SDWebImageRefreshCached) downloaderOptions |= SDWebImageDownloaderUseNSURLCache;</div><div class="line">            <span class="keyword">if</span> (options &amp; SDWebImageContinueInBackground) downloaderOptions |= SDWebImageDownloaderContinueInBackground;</div><div class="line">            <span class="keyword">if</span> (options &amp; SDWebImageHandleCookies) downloaderOptions |= SDWebImageDownloaderHandleCookies;</div><div class="line">            <span class="keyword">if</span> (options &amp; SDWebImageAllowInvalidSSLCertificates) downloaderOptions |= SDWebImageDownloaderAllowInvalidSSLCertificates;</div><div class="line">            <span class="keyword">if</span> (options &amp; SDWebImageHighPriority) downloaderOptions |= SDWebImageDownloaderHighPriority;</div><div class="line">            <span class="keyword">if</span> (image &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</div><div class="line">                <span class="comment">// force progressive off if image already cached but forced refreshing</span></div><div class="line">                downloaderOptions &amp;= ~SDWebImageDownloaderProgressiveDownload;</div><div class="line">                <span class="comment">// ignore image read from NSURLCache if image if cached but force refreshing</span></div><div class="line">                downloaderOptions |= SDWebImageDownloaderIgnoreCachedResponse;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// 调用imageDownloader去下载image并且返回执行这个request的download的operation</span></div><div class="line">            <span class="keyword">id</span> &lt;SDWebImageOperation&gt; subOperation = [<span class="keyword">self</span>.imageDownloader downloadImageWithURL:url options:downloaderOptions progress:progressBlock completed:^(<span class="built_in">UIImage</span> *downloadedImage, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, <span class="built_in">BOOL</span> finished) &#123;</div><div class="line">                <span class="keyword">if</span> (weakOperation.isCancelled) &#123;</div><div class="line">                    <span class="comment">// Do nothing if the operation was cancelled</span></div><div class="line">                    <span class="comment">// See #699 for more details</span></div><div class="line">                    <span class="comment">// if we would call the completedBlock, there could be a race condition between this block and another completedBlock for the same object, so if this one is called second, we will overwrite the new data</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (error) &#123;</div><div class="line">                    dispatch_main_sync_safe(^&#123;</div><div class="line">                        <span class="keyword">if</span> (!weakOperation.isCancelled) &#123;</div><div class="line">                            completedBlock(<span class="literal">nil</span>, error, SDImageCacheTypeNone, finished, url);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                    </div><div class="line">                    <span class="keyword">if</span> (error.code != <span class="built_in">NSURLErrorNotConnectedToInternet</span> &amp;&amp; error.code != <span class="built_in">NSURLErrorCancelled</span> &amp;&amp; error.code != <span class="built_in">NSURLErrorTimedOut</span>) &#123;</div><div class="line">                        <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.failedURLs) &#123;</div><div class="line">                            [<span class="keyword">self</span>.failedURLs addObject:url];</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> ((options &amp; SDWebImageRetryFailed)) &#123;</div><div class="line">                        <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.failedURLs) &#123;</div><div class="line">                            [<span class="keyword">self</span>.failedURLs removeObject:url];</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    <span class="built_in">BOOL</span> cacheOnDisk = !(options &amp; SDWebImageCacheMemoryOnly);</div><div class="line">                    </div><div class="line">                    <span class="keyword">if</span> (options &amp; SDWebImageRefreshCached &amp;&amp; image &amp;&amp; !downloadedImage) &#123;</div><div class="line">                        <span class="comment">// Image refresh hit the NSURLCache cache, do not call the completion block</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (downloadedImage &amp;&amp; (!downloadedImage.images || (options &amp; SDWebImageTransformAnimatedImage)) &amp;&amp; [<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(imageManager:transformDownloadedImage:withURL:)]) &#123;</div><div class="line">                        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</div><div class="line">                            <span class="built_in">UIImage</span> *transformedImage = [<span class="keyword">self</span>.delegate imageManager:<span class="keyword">self</span> transformDownloadedImage:downloadedImage withURL:url];</div><div class="line">                            </div><div class="line">                            <span class="keyword">if</span> (transformedImage &amp;&amp; finished) &#123;</div><div class="line">                                <span class="built_in">BOOL</span> imageWasTransformed = ![transformedImage isEqual:downloadedImage];</div><div class="line">                                [<span class="keyword">self</span>.imageCache storeImage:transformedImage recalculateFromImage:imageWasTransformed imageData:data forKey:key toDisk:cacheOnDisk];</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            dispatch_main_sync_safe(^&#123;</div><div class="line">                                <span class="keyword">if</span> (!weakOperation.isCancelled) &#123;</div><div class="line">                                    completedBlock(transformedImage, <span class="literal">nil</span>, SDImageCacheTypeNone, finished, url);</div><div class="line">                                &#125;</div><div class="line">                            &#125;);</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (downloadedImage &amp;&amp; finished) &#123;</div><div class="line">                            [<span class="keyword">self</span>.imageCache storeImage:downloadedImage recalculateFromImage:<span class="literal">NO</span> imageData:data forKey:key toDisk:cacheOnDisk];</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        dispatch_main_sync_safe(^&#123;</div><div class="line">                            <span class="keyword">if</span> (!weakOperation.isCancelled) &#123;</div><div class="line">                                completedBlock(downloadedImage, <span class="literal">nil</span>, SDImageCacheTypeNone, finished, url);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                <span class="keyword">if</span> (finished) &#123;</div><div class="line">                    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</div><div class="line">                        [<span class="keyword">self</span>.runningOperations removeObject:operation];</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;];</div><div class="line">            operation.cancelBlock = ^&#123;</div><div class="line">                [subOperation cancel];</div><div class="line">                </div><div class="line">                <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</div><div class="line">                    [<span class="keyword">self</span>.runningOperations removeObject:weakOperation];</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (image) &#123;</div><div class="line">            dispatch_main_sync_safe(^&#123;</div><div class="line">                <span class="keyword">if</span> (!weakOperation.isCancelled) &#123;</div><div class="line">                    completedBlock(image, <span class="literal">nil</span>, cacheType, <span class="literal">YES</span>, url);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</div><div class="line">                [<span class="keyword">self</span>.runningOperations removeObject:operation];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Image not in cache and download disallowed by delegate</span></div><div class="line">            dispatch_main_sync_safe(^&#123;</div><div class="line">                <span class="keyword">if</span> (!weakOperation.isCancelled) &#123;</div><div class="line">                    completedBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, SDImageCacheTypeNone, <span class="literal">YES</span>, url);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</div><div class="line">                [<span class="keyword">self</span>.runningOperations removeObject:operation];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> operation;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)saveImageToCache:(<span class="built_in">UIImage</span> *)image forURL:(<span class="built_in">NSURL</span> *)url &#123;</div><div class="line">    <span class="keyword">if</span> (image &amp;&amp; url) &#123;</div><div class="line">        <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</div><div class="line">        [<span class="keyword">self</span>.imageCache storeImage:image forKey:key toDisk:<span class="literal">YES</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// cancel掉所有正在执行的operation</span></div><div class="line">- (<span class="keyword">void</span>)cancelAll &#123;</div><div class="line">    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</div><div class="line">        <span class="built_in">NSArray</span> *copiedOperations = [<span class="keyword">self</span>.runningOperations <span class="keyword">copy</span>];</div><div class="line">        [copiedOperations makeObjectsPerformSelector:<span class="keyword">@selector</span>(cancel)];</div><div class="line">        [<span class="keyword">self</span>.runningOperations removeObjectsInArray:copiedOperations];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 判断是否有正在运行的operation</span></div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isRunning &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.runningOperations.count &gt; <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SDWebImageCombinedOperation</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setCancelBlock:(SDWebImageNoParamsBlock)cancelBlock &#123;</div><div class="line">    <span class="comment">// check if the operation is already cancelled, then we just call the cancelBlock</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) &#123;</div><div class="line">        <span class="keyword">if</span> (cancelBlock) &#123;</div><div class="line">            cancelBlock();</div><div class="line">        &#125;</div><div class="line">        _cancelBlock = <span class="literal">nil</span>; <span class="comment">// don't forget to nil the cancelBlock, otherwise we will get crashes</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        _cancelBlock = [cancelBlock <span class="keyword">copy</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)cancel &#123;</div><div class="line">    <span class="keyword">self</span>.cancelled = <span class="literal">YES</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.cacheOperation) &#123;</div><div class="line">        [<span class="keyword">self</span>.cacheOperation cancel];</div><div class="line">        <span class="keyword">self</span>.cacheOperation = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.cancelBlock) &#123;</div><div class="line">        <span class="keyword">self</span>.cancelBlock();</div><div class="line">        </div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> this is a temporary fix to #809.</span></div><div class="line">        <span class="comment">// Until we can figure the exact cause of the crash, going with the ivar instead of the setter</span></div><div class="line">        <span class="comment">//        self.cancelBlock = nil;</span></div><div class="line">        _cancelBlock = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SDWebImageManager</span> (<span class="title">Deprecated</span>)</span></div><div class="line"></div><div class="line"><span class="comment">// deprecated method, uses the non deprecated method</span></div><div class="line"><span class="comment">// adapter for the completion block</span></div><div class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadWithURL:(<span class="built_in">NSURL</span> *)url options:(SDWebImageOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageCompletedWithFinishedBlock)completedBlock &#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> downloadImageWithURL:url</div><div class="line">                              options:options</div><div class="line">                             progress:progressBlock</div><div class="line">                            completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</div><div class="line">                                <span class="keyword">if</span> (completedBlock) &#123;</div><div class="line">                                    completedBlock(image, error, cacheType, finished);</div><div class="line">                                &#125;</div><div class="line">                            &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/15/2015-05-15-sdwebimageyuan-ma-jie-xi/" data-id="cj11z9jec000cuczjxy0pzind" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-07-objective-c-runtime-si-dong-tai-fang-fa-jue-yi-dynamic-method-resolution" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/07/2015-05-07-objective-c-runtime-si-dong-tai-fang-fa-jue-yi-dynamic-method-resolution/" class="article-date">
  <time datetime="2015-05-07T14:29:59.000Z" itemprop="datePublished">2015-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/07/2015-05-07-objective-c-runtime-si-dong-tai-fang-fa-jue-yi-dynamic-method-resolution/">Objective-C Runtime(四) 动态方法决议</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<blockquote>
<p>动态方法决议/动态方法解析(Dynamic Method Resolution)</p>
</blockquote>
<p>在声明property属性后，有2种实现选择</p>
<ul>
<li>@synthesize</li>
</ul>
<p>编译器期间，让编译器自动生成getter/setter方法。当有自定义的存或取方法时，自定义会屏蔽自动生成该方法</p>
<ul>
<li>@dynamic</li>
</ul>
<p>告诉编译器，不自动生成getter/setter方法，避免编译期间产生警告,然后由自己实现存取方法或存取方法在运行时动态创建绑定。</p>
<p>由于使用@dynamic，我们需要自己提供setter和getter方法。一般有两种方法：</p>
<p>1). 自己提供setter和getter方法，将编译器自动生成的setter和getter方法手动再写一遍；<br>注意：需要在类中显式提供实例变量，因为@dynamic不能像@synthesize那样向实现文件(.m)提供实例变量。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// must provide a ivar for our setter and getter</span></div><div class="line">    <span class="built_in">NSString</span> *_name;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="comment">// @dynamic tells compiler don't generate setter and getter automatically</span></div><div class="line"><span class="keyword">@dynamic</span> name;</div><div class="line"></div><div class="line"><span class="comment">// We provide setter and getter here</span></div><div class="line">- (<span class="keyword">void</span>) setName:(<span class="built_in">NSString</span> *)name</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (_name != name) &#123;</div><div class="line">        [_name release];</div><div class="line">        _name = [name <span class="keyword">copy</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *) name</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _name;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span> <span class="comment">// Person</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</div><div class="line">    </div><div class="line">    Person *a = [[Person alloc] init];</div><div class="line">    </div><div class="line">    a.name = <span class="string">@"Hello"</span>; <span class="comment">// Ok, use our setter</span></div><div class="line">    a.name = <span class="string">@"Hello, world"</span>;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.name); <span class="comment">// Ok, use our getter</span></div><div class="line">    </div><div class="line">    [a release];</div><div class="line">    [pool drain];</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; <span class="comment">// main</span></div></pre></td></tr></table></figure>
<p>2). 动态方法决议(DynamicMethod Resolution)，在运行时提供setter和getter对应实现的C函数。</p>
<p>第二种方法，在运行时决定setter和getter对应实现的C函数，使用了NSObject提供的resolveInstanceMethod:方法。在C函数中不能直接使用实例变量，需要将ObjC对象self转成C中的结构体，因此在Person类同样需要显式声明实例变量而且访问级别是@public，为了隐藏该实例变量，将声明放在扩展(extension)中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/objc-runtime.h&gt;</span> // for class_addMethod()</span></div><div class="line"></div><div class="line"><span class="comment">// ------------------------------------------------------</span></div><div class="line"><span class="comment">// A .h file</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>) hello;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// ------------------------------------------------------</span></div><div class="line"><span class="comment">// A .m file</span></div><div class="line"><span class="comment">// Use extension to override the access level of _name ivar</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> ()</span></div><div class="line">&#123;</div><div class="line"><span class="keyword">@public</span></div><div class="line">    <span class="built_in">NSString</span> *_name;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="comment">// @dynamic implies compiler to look for setName: and name method in runtime</span></div><div class="line"><span class="keyword">@dynamic</span> name;</div><div class="line"></div><div class="line"><span class="comment">// Only resolve unrecognized methods, and only load methods dynamically once</span></div><div class="line">+ (<span class="built_in">BOOL</span>) resolveInstanceMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Capture setName: and name method</span></div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(setName:)) &#123;</div><div class="line">        class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], sel, (IMP)setName, <span class="string">"v@:@"</span>);</div><div class="line"><span class="comment">/*</span></div><div class="line">@encode()可以接受任何类型，Objective-C 中用这个指令做类型编码，它可以把任何一个类型转换为字符串，譬如：void 类型被编码之后为v，对象类型为@，SEL 类型为:等，具体的你可以参看Apple 官方页面关于Type Encoding 的描述：</div><div class="line">http://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW</div><div class="line">现在我们来正式的看以下第四个参数v@:f 的含义，它描述了IMP 指向的函数的描述信息，按照@encode指令编译之后的字符说明，第一个字符v 表示返回值为void，剩余的字符为dynamicMethod函数的参数描述，@表示第一个参数id，:自然就是第二个参数SEL，f就是第三个参数float。由于前面说过动态方法的实现的前两个参数必须是id、SEL，所以第四个参数中的字符串的第二、三个字符一定是@:。</div><div class="line">*/</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(name)) &#123;</div><div class="line">        class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], sel, (IMP)getName, <span class="string">"@@:"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//+ (BOOL)resolveClassMethod:(SEL)name</span></div><div class="line"><span class="comment">//&#123;</span></div><div class="line"><span class="comment">//    NSLog(@" &gt;&gt; Class resolving %@", NSStringFromSelector(name));</span></div><div class="line"><span class="comment">//    </span></div><div class="line"><span class="comment">//    return [super resolveClassMethod:name];</span></div><div class="line"><span class="comment">//&#125;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> setName(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span>* name)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Implement @property (copy)</span></div><div class="line">    <span class="keyword">if</span> (((Person *)<span class="keyword">self</span>)-&gt;_name != name) &#123;</div><div class="line">        [((Person *)<span class="keyword">self</span>)-&gt;_name release];</div><div class="line">        ((Person *)<span class="keyword">self</span>)-&gt;_name = [name <span class="keyword">copy</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">NSString</span>* getName(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> ((Person *)<span class="keyword">self</span>)-&gt;_name;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>) hello</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Hello, world"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span> <span class="comment">// Person</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</div><div class="line">    </div><div class="line">    Person *a = [[Person alloc] init];</div><div class="line">    [a hello]; <span class="comment">// never call resolveInstanceMethod</span></div><div class="line">    </div><div class="line">    a.name = <span class="string">@"hello1"</span>;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.name);</div><div class="line">    a.name = <span class="string">@"hello2"</span>;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.name);</div><div class="line">    </div><div class="line">    [a release];</div><div class="line">    [pool drain];</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; <span class="comment">// main</span></div></pre></td></tr></table></figure>
<p>Objective-C 的运行时只要发现你调用了@dynamic标注的属性的<br>setter、getter 方法，就会自动到resolveInstanceMethod 里去寻找真实的实现。实际上除了@dynamic标注的属性之外，如果你调用了类型中不存在的方法，也会被resolveInstanceMethod或者<br>resolveClassMethod截获，但由于你没有处理，所以会报告不能识别的消息的错误。一般Objective-C的运行时编程用到的并不多，除非你想设计一个动态化的功能，譬如：从网络下载一个升级包，不需要退出原有的程序，就可以动态的替换掉旧的功能等类似的需求。</p>
<hr>
<p>####动态方法决议</p>
<p>研究运行时系统是如何进行动态方法决议的，下面的代码来自苹果官方公开的源码 objc-class.mm，我在其中添加了中文注释：</p>
<p>1，首先是判断是不是要进行类方法决议，如果不是或决议失败，则进行实例方法决议</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**********************************************************</span></div><div class="line">* _class_resolveMethod</div><div class="line">* Call +resolveClassMethod or +resolveInstanceMethod and return </div><div class="line">* the method added or NULL. </div><div class="line">* Assumes the method doesn't exist already.</div><div class="line">***********************************************************/</div><div class="line">__private_extern__ Method _class_resolveMethod(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    Method meth = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (_class_isMetaClass(cls)) &#123;</div><div class="line">        meth = _class_resolveClassMethod(cls, sel);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!meth) &#123;</div><div class="line">        meth = _class_resolveInstanceMethod(cls, sel);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (PrintResolving  &amp;&amp;  meth) &#123;</div><div class="line">        _objc_inform(<span class="string">"RESOLVE: method %c[%s %s] dynamically resolved to %p"</span>, </div><div class="line">                     class_isMetaClass(cls) ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                     class_getName(cls), sel_getName(sel), </div><div class="line">                     method_getImplementation(meth));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> meth;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2，类方法决议与实例方法决议大体相似，在这里就只看实例方法决议部分了：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/***********************************************************************</span></div><div class="line"> * _class_resolveInstanceMethod</div><div class="line"> * Call +resolveInstanceMethod and return the method added or NULL.</div><div class="line"> * cls should be a non-meta class.</div><div class="line"> * Assumes the method doesn't exist already.</div><div class="line"> **********************************************************************/</div><div class="line"><span class="keyword">static</span> Method _class_resolveInstanceMethod(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> resolved;</div><div class="line">    Method meth = <span class="literal">NULL</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 是否实现了 resolveInstanceMethod，如果没有返回 NULL</span></div><div class="line">    <span class="keyword">if</span> (!look_up_method(((<span class="keyword">id</span>)cls)-&gt;isa, SEL_resolveInstanceMethod, </div><div class="line">                        <span class="literal">YES</span> <span class="comment">/*cache*/</span>, <span class="literal">NO</span> <span class="comment">/*resolver*/</span>))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 调用 resolveInstanceMethod，并获取返回值</span></div><div class="line">    resolved = ((<span class="built_in">BOOL</span>(*)(<span class="keyword">id</span>, SEL, SEL))objc_msgSend)((<span class="keyword">id</span>)cls, SEL_resolveInstanceMethod, sel);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (resolved) &#123;</div><div class="line">        <span class="comment">// 返回值为 YES，表示 resolveInstanceMethod 声称它已经成功添加实现，则再次查找 method list </span></div><div class="line">        <span class="comment">// +resolveClassMethod adds to self</span></div><div class="line">        meth = look_up_method(cls, sel, <span class="literal">YES</span><span class="comment">/*cache*/</span>, <span class="literal">NO</span><span class="comment">/*resolver*/</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (!meth) &#123;</div><div class="line">            <span class="comment">// resolveInstanceMethod 使诈了，它声称成功添加实现了，但实际没有，给出警告信息，并返回 NULL</span></div><div class="line">            <span class="comment">// Method resolver didn't add anything?</span></div><div class="line">            _objc_inform(<span class="string">"+[%s resolveInstanceMethod:%s] returned YES, but "</span></div><div class="line">                         <span class="string">"no new implementation of %c[%s %s] was found"</span>, </div><div class="line">                         class_getName(cls),</div><div class="line">                         sel_getName(sel), </div><div class="line">                         class_isMetaClass(cls) ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         class_getName(cls), </div><div class="line">                         sel_getName(sel));</div><div class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 其他情况下返回 NULL</span></div><div class="line">    <span class="keyword">return</span> meth;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码很容易理解：</p>
<ol>
<li>首先判断是否实现了 resolveInstanceMethod，如果没有实现，返回 NULL，进入下一步处理；</li>
<li>如果实现了，调用 resolveInstanceMethod，获取返回值；</li>
<li>如果返回值为 YES，表示 resolveInstanceMethod 声称它已经提供了 selector 的实现，因此再次查找 method list，如果找到对应的IMP，则返回该实现，否则提示警告信息，返回 NULL，进入下一步处理；</li>
<li>如果返回值为 NO，返回 NULL，进入下一步处理；</li>
</ol>
<h4 id="加入消息转发"><a href="#加入消息转发" class="headerlink" title="加入消息转发"></a>加入消息转发</h4><p>在前文<a href="http://www.cnblogs.com/kesalin/archive/2011/08/15/objc_method_base.html" target="_blank" rel="external">《深入浅出Cocoa之消息》</a>，我演示了一个消息转发的示例，下面我把动态方法决议部分去除，把消息转发部分添加进来：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Proxy</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Proxy</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)MissMethod;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Proxy</span></span></div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)MissMethod</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@" &gt;&gt; MissMethod() called in Proxy."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// Foo</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Foo</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)Bar;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Foo</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</div><div class="line">&#123;</div><div class="line">    SEL name = [anInvocation selector];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@" &gt;&gt; forwardInvocation for selector %@"</span>, <span class="built_in">NSStringFromSelector</span>(name));</div><div class="line">    </div><div class="line">    Proxy * proxy = [[[Proxy alloc] init] autorelease];</div><div class="line">    <span class="keyword">if</span> ([proxy respondsToSelector:name]) &#123;</div><div class="line">        [anInvocation invokeWithTarget:proxy];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</div><div class="line">    <span class="keyword">return</span> [Proxy instanceMethodSignatureForSelector:aSelector];</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)Bar</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@" &gt;&gt; Bar() in Foo."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>运行测试代码，输出如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt; Bar() <span class="keyword">in</span> Foo.</div><div class="line">&gt;&gt; forwardInvocation <span class="keyword">for</span> selector MissMethod</div><div class="line">&gt;&gt; MissMethod() called <span class="keyword">in</span> Proxy.</div></pre></td></tr></table></figure>
<p>如果我把动态方法决议部分代码也加入进来输出又是怎样呢？下面只列出了 Foo 的实现代码，其他代码不变动。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Foo</span></span></div><div class="line"></div><div class="line">+(<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)name</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@" &gt;&gt; Instance resolving %@"</span>, <span class="built_in">NSStringFromSelector</span>(name));</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (name == <span class="keyword">@selector</span>(MissMethod)) &#123;</div><div class="line">        class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], name, (IMP)dynamicMethodIMP, <span class="string">"v@:"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:name];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)name</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@" &gt;&gt; Class resolving %@"</span>, <span class="built_in">NSStringFromSelector</span>(name));</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveClassMethod:name];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</div><div class="line">&#123;</div><div class="line">    SEL name = [anInvocation selector];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@" &gt;&gt; forwardInvocation for selector %@"</span>, <span class="built_in">NSStringFromSelector</span>(name));</div><div class="line">    </div><div class="line">    Proxy * proxy = [[[Proxy alloc] init] autorelease];</div><div class="line">    <span class="keyword">if</span> ([proxy respondsToSelector:name]) &#123;</div><div class="line">        [anInvocation invokeWithTarget:proxy];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</div><div class="line">    <span class="keyword">return</span> [Proxy instanceMethodSignatureForSelector:aSelector];</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)Bar</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@" &gt;&gt; Bar() in Foo."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>此时，输出为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt; Bar() <span class="keyword">in</span> Foo.</div><div class="line">&gt;&gt; Instance resolving MissMethod</div><div class="line">&gt;&gt; dynamicMethodIMP called.</div><div class="line">&gt;&gt; Instance resolving _doZombieMe</div></pre></td></tr></table></figure>
<p>注意到了没，消息转发没有进行！在前文中说过，消息转发只有在对象无法正常处理消息时才会调用，而在这里我在动态方法决议中为 selector 提供了实现，使得对象可以处理该消息，所以消息转发不会继续了。官方文档中说：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">If you implement resolveInstanceMethod: but want particular selectors to actually be forwarded via the forwarding mechanism, you <span class="keyword">return</span> <span class="literal">NO</span> <span class="keyword">for</span> those selectors.</div></pre></td></tr></table></figure>
<p>文档里的说法其实并不准确，只有在 resolveInstanceMethod 的实现中没有真正为 selector 提供实现，并返回 NO 的情况下才会进入消息转发流程；否则绝不会进入消息转发流程，程序要么调用正确的动态方法，要么 crash。这也与前面的源码不太一致，我猜测在比上面源码的更高层次的地方，再次查找了 method list，如果提供了实现就能够找到该实现。</p>
<p>下面我把 resolveInstanceMethod 方法中为 selector 添加实现的那一行屏蔽了，消息转发就应该会进行:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//class_addMethod([self class], name, (IMP)dynamicMethodIMP, "v@:");</span></div></pre></td></tr></table></figure>
<p>再次编译运行，此时输出正如前面所推断的那样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt;&gt; Bar() <span class="keyword">in</span> Foo.</div><div class="line">&gt;&gt; Instance resolving MissMethod</div><div class="line">objc[<span class="number">1618</span>]: +[Foo resolveInstanceMethod:MissMethod] returned <span class="literal">YES</span>, but no new implementation of -[Foo MissMethod] was found</div><div class="line">&gt;&gt; forwardInvocation <span class="keyword">for</span> selector MissMethod</div><div class="line">&gt;&gt; MissMethod() called <span class="keyword">in</span> Proxy.</div><div class="line">&gt;&gt; Instance resolving _doZombieMe</div></pre></td></tr></table></figure>
<p>进行了消息转发！而且编译器很善意地提示（见前面源码剖析）：哎呀，你不能欺骗我嘛，你说添加了实现（返回YES），其实还是没有呀！然后编译器就无奈地去看能不能消息转发了。当然如果把返回值修改为 NO 就不会有该警告出现，其他的输出不变。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>从上面的示例演示可以看出，动态方法决议是先于消息转发的。</p>
<p>如果向一个 Objective C 对象发送它无法处理的消息（selector），那么编译器会按照如下次序进行处理：</p>
<p>1  首先看是否为该 selector 提供了动态方法决议机制，如果提供了则转到2；如果没有提供则转到 3；</p>
<ol>
<li><p>如果动态方法决议真正为该selector 提供了实现,那么就调用该实现,完成消息发送流程,消息转发就不会进行了;如果没有提供,则转到 3；</p>
</li>
<li><p>其次看是否为该 selector 提供了消息转发机制，如果提供了消息了则进行消息转发，此时，无论消息转发是怎样实现的，程序均不会crash。（因为消息调用的控制权完全交给消息转发机制处理，即使消息转发并没有做任何事情，运行也不会有错误，编译器更不会有错误提示。）；如果没提供消息转发机制，则转到 4；</p>
</li>
<li><p>运行报错：无法识别的 selector，程序 crash；</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/07/2015-05-07-objective-c-runtime-si-dong-tai-fang-fa-jue-yi-dynamic-method-resolution/" data-id="cj11z9je90009uczjhkcgierf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-06-objective-c-runtime-san-xiao-xi-chuan-di" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/06/2015-05-06-objective-c-runtime-san-xiao-xi-chuan-di/" class="article-date">
  <time datetime="2015-05-06T13:51:41.000Z" itemprop="datePublished">2015-05-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/06/2015-05-06-objective-c-runtime-san-xiao-xi-chuan-di/">Objective-C Runtime(三) 消息传递</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>###Objective-C – 消息传递<br>Objective-C 扩展了 C 语言，并加入了面向对象特性和 Smalltalk 式的消息传递机制。而这个扩展的核心是一个用 C 和 编译语言 写的 Runtime 库。它是 Objective-C 面向对象和动态机制的基石.</p>
<p>Objective-C 是一个动态语言，这意味着它不仅需要一个编译器，也需要一个运行时系统来动态得创建类和对象、进行消息传递和转发。理解 Objective-C 的 Runtime 机制可以帮我们更好的了解这个语言，适当的时候还能对语言进行扩展，从系统层面解决项目中的一些设计或技术问题。了解 Runtime ，要先了解它的核心 - <code>消息传递</code>（Messaging）。</p>
<hr>
<h3 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h3><p>在很多语言，比如 C ，调用一个方法其实就是跳到内存中的某一点并开始执行一段代码。没有任何动态的特性，因为这在编译时就决定好了。而在 Objective-C 中，[object foo] 语法并不会立即执行 foo 这个方法的代码。它是在运行时给 object 发送一条叫 foo 的消息。这个消息，也许会由 object 来处理，也许会被转发给另一个对象，或者不予理睬假装没收到这个消息。多条不同的消息也可以对应同一个方法实现。这些都是在程序运行的时候决定的。</p>
<p>事实上，在编译时你写的 Objective-C 函数调用的语法都会被翻译成一个 C 的函数调用<code>- objc_msgSend()</code> 。比如，下面两行代码就是等价的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[array insertObject:foo atIndex:<span class="number">5</span>];</div><div class="line"></div><div class="line">objc_msgSend(array, <span class="keyword">@selector</span>(insertObject:atIndex:), foo, <span class="number">5</span>);</div></pre></td></tr></table></figure>
<p>消息传递的关键藏于 <code>objc_object</code> 中的 isa 指针和 <code>objc_class</code> 中的 class dispatch table。</p>
<h2 id="objc-object-objc-class以及Ojbc-method"><a href="#objc-object-objc-class以及Ojbc-method" class="headerlink" title="objc_object, objc_class以及Ojbc_method"></a><code>objc_object, objc_class</code>以及<code>Ojbc_method</code></h2><p>在 Objective-C 中，类、对象和方法都是一个 C 的结构体，从 objc/objc.h 头文件中，我们可以找到他们的定义：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_object &#123;  </div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> objc_class &#123;  </div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line"><span class="meta">#if !__OBJC2__</span></div><div class="line">    Class super_class;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</div><div class="line">    <span class="keyword">long</span> version;</div><div class="line">    <span class="keyword">long</span> info;</div><div class="line">    <span class="keyword">long</span> instance_size;</div><div class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars;</div><div class="line">    **<span class="keyword">struct</span> objc_method_list **methodLists**;</div><div class="line">    **<span class="keyword">struct</span> objc_cache *cache**;</div><div class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols;</div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> objc_method_list &#123;  </div><div class="line">    <span class="keyword">struct</span> objc_method_list *obsolete;</div><div class="line">    <span class="keyword">int</span> method_count;</div><div class="line"></div><div class="line"><span class="meta">#ifdef __LP64__</span></div><div class="line">    <span class="keyword">int</span> space;</div><div class="line"><span class="meta">#endif</span></div><div class="line"></div><div class="line">    <span class="comment">/* variable length structure */</span></div><div class="line">    <span class="keyword">struct</span> objc_method method_list[<span class="number">1</span>];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> objc_method &#123;  </div><div class="line">    SEL method_name;</div><div class="line">    <span class="keyword">char</span> *method_types;    <span class="comment">/* a string representing argument/return types */</span></div><div class="line">    IMP method_imp;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>objc_method_list</code> 本质是一个有 <code>objc_method</code> 元素的可变长度的数组。一个 <code>objc_method</code> 结构体中有函数名，也就是SEL，有表示函数类型的字符串 (见 Type Encoding) ，以及函数的实现IMP。</p>
<p>从这些定义中可以看出发送一条消息也就 <code>objc_msgSend</code> 做了什么事。举 <code>objc_msgSend(obj, foo)</code> 这个例子来说：</p>
<p>1.首先，通过 obj 的 isa 指针找到它的 class ;</p>
<p>2.在 class 的 method list 找 foo ;</p>
<p>3.如果 class 中没到 foo，继续往它的 superclass 中找 ;</p>
<p>4.一旦找到 foo 这个函数，就去执行它的实现IMP .</p>
<p>但这种实现有个问题，效率低。但一个 class 往往只有 20% 的函数会被经常调用，可能占总调用次数的 80% 。每个消息都需要遍历一次 <code>objc_method_list</code> 并不合理。如果把经常被调用的函数缓存下来，那可以大大提高函数查询的效率。这也就是 <code>objc_class</code> 中另一个重要成员 <code>objc_cache</code> 做的事情 - 再找到 foo 之后，把 foo 的 <code>method_name</code> 作为 key ，<code>method_imp</code> 作为 value 给存起来。当再次收到 foo 消息的时候，可以直接在 cache 里找到，避免去遍历 <code>objc_method_list</code>.</p>
<hr>
<h3 id="动态方法解析和转发"><a href="#动态方法解析和转发" class="headerlink" title="动态方法解析和转发"></a>动态方法解析和转发</h3><p>在上面的例子中，如果 foo 没有找到会发生什么？通常情况下，程序会在运行时挂掉并抛出 <code>unrecognized selector sent to …</code>的异常。但在异常抛出前，Objective-C 的运行时会给你三次拯救程序的机会：</p>
<ul>
<li>Method resolution</li>
<li>Fast forwarding</li>
<li>Normal forwarding</li>
</ul>
<p>###Method Resolution</p>
<p>首先，Objective-C 运行时会调用<code>+resolveInstanceMethod:</code> 或者 <code>+resolveClassMethod:</code>，让你有机会提供一个函数实现。如果你添加了函数并返回 YES， 那运行时系统就会重新启动一次消息发送的过程。还是以 foo 为例，你可以这么实现：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> fooMethod(<span class="keyword">id</span> obj, SEL _cmd)  </div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Doing foo"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)aSEL</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(aSEL == <span class="keyword">@selector</span>(foo:))&#123;</div><div class="line">        class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], aSEL, (IMP)fooMethod, <span class="string">"v@:"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Core Data 有用到这个方法。NSManagedObjects 中 properties 的 getter 和 setter 就是在运行时动态添加的。</p>
<p>如果 resolve 方法返回 NO ，运行时就会移到下一步：<code>消息转发（Message Forwarding）</code>。</p>
<p>上面的例子可以重写成：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">IMP fooIMP = imp_implementationWithBlock(^(<span class="keyword">id</span> _<span class="keyword">self</span>) &#123;  </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Doing foo"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], aSEL, fooIMP, <span class="string">"v@:"</span>);</div></pre></td></tr></table></figure></p>
<h3 id="Fast-forwarding"><a href="#Fast-forwarding" class="headerlink" title="Fast forwarding"></a>Fast forwarding</h3><p>如果目标对象实现了 -forwardingTargetForSelector: ，Runtime 这时就会调用这个方法，给你把这个消息转发给其他对象的机会。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(aSelector == <span class="keyword">@selector</span>(foo:))&#123;</div><div class="line">        <span class="keyword">return</span> alternateObject;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只要这个方法返回的不是 nil 和 self，整个消息发送的过程就会被重启，当然发送的对象会变成你返回的那个对象。否则，就会继续 Normal Fowarding 。</p>
<p>这里叫 Fast ，只是为了区别下一步的转发机制。因为这一步不会创建任何新的对象，但下一步转发会创建一个 NSInvocation 对象，所以相对更快点。</p>
<p>###Normal forwarding<br>这一步是 Runtime 最后一次给你挽救的机会。首先它会发送 <code>-methodSignatureForSelector:</code>消息获得函数的参数和返回值类型。如果 <code>-methodSignatureForSelector:</code>返回 nil ，Runtime 则会发出 <code>-doesNotRecognizeSelector:</code> 消息，程序这时也就挂掉了。如果返回了一个函数签名，Runtime 就会创建一个 NSInvocation 对象并发送 <code>-forwardInvocation:</code>消息给目标对象。</p>
<p>NSInvocation 实际上就是对一个消息的描述，包括selector 以及参数等信息。所以你可以在<code>-forwardInvocation:</code>里修改传进来的 NSInvocation 对象，然后发送<code>-invokeWithTarget:</code> 消息给它，传进去一个新的目标：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSMethodSignature</span>*)methodSignatureForSelector:(SEL)selector</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSMethodSignature</span>* signature = [<span class="keyword">super</span> methodSignatureForSelector:selector];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!signature)</div><div class="line">    signature = [alternateObject methodSignatureForSelector:selector];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> signature;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation</div><div class="line">&#123;</div><div class="line">    SEL sel = invocation.selector;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>([alternateObject respondsToSelector:sel]) &#123;</div><div class="line">        [invocation invokeWithTarget:alternateObject];</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Cocoa 里很多地方都利用到了消息传递机制来对语言进行扩展，如 Proxies、NSUndoManager 跟 Responder Chain。NSProxy 就是专门用来作为代理转发消息的；NSUndoManager 截取一个消息之后再发送；而 Responder Chain 保证一个消息转发给合适的响应者。</p>
<hr>
<p>##总结<br>Objective-C 中给一个对象发送消息会经过以下几个步骤：</p>
<p>1.在对象类的 dispatch table 中尝试找到该消息。如果找到了，跳到相应的函数IMP去执行实现代码；</p>
<p>2.如果没有找到，Runtime 会发送 <code>+resolveInstanceMethod:</code>或者 <code>+resolveClassMethod:</code>尝试去 resolve 这个消息；</p>
<p>3.如果 resolve 方法返回 NO，Runtime 就发送<code>-forwardingTargetForSelector:</code> 允许你把这个消息转发给另一个对象；</p>
<p>4.如果没有新的目标对象返回， Runtime 就会发送<code>-methodSignatureForSelector:</code> 和<code>-forwardInvocation:</code>消息。你可以发送 <code>-invokeWithTarget:</code> 消息来手动转发消息或者发送<code>-doesNotRecognizeSelector:</code>抛出异常。</p>
<p>利用 Objective-C 的 runtime特性，我们可以自己来对语言进行扩展，解决项目开发中的一些设计和技术问题。下一篇文章，我会介绍 <code>Method Swizzling</code> 技术以及如何利用 <code>Method Swizzling</code> 做 Logging。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/06/2015-05-06-objective-c-runtime-san-xiao-xi-chuan-di/" data-id="cj11z9je80007uczjt0tf6umq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-05-runtime-gai-shu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/05/2015-05-05-runtime-gai-shu/" class="article-date">
  <time datetime="2015-05-05T09:55:39.000Z" itemprop="datePublished">2015-05-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/05/2015-05-05-runtime-gai-shu/">Objective-C Runtime(一) 概述</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h3 id="Runtime方法列表"><a href="#Runtime方法列表" class="headerlink" title="Runtime方法列表"></a>Runtime方法列表</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># class</span></div><div class="line">class_getInstanceMethod -&gt; Method class_getInstanceMethod(Class cls, SEL name);<span class="comment">// 返回给定类的指定的实例方法</span></div><div class="line">class_addMethod -&gt; <span class="built_in">BOOL</span> class_addMethod(Class cls, SEL name, IMP imp, <span class="keyword">const</span> <span class="keyword">char</span> *types);<span class="comment">// 通过方法名SEL+原来的IMP实现给类添加新方法</span></div><div class="line">class_copyPropertyList -&gt; objc_property_t *class_copyPropertyList(Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount) <span class="comment">// 获取类的属性列表</span></div><div class="line"></div><div class="line"><span class="meta"># method</span></div><div class="line"></div><div class="line">method_getTypeEncoding -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *method_getTypeEncoding(Method m);<span class="comment">// Returns a string describing a method's parameter and return types.</span></div><div class="line">method_getImplementation -&gt; IMP method_getImplementation(Method m);<span class="comment">//获取Method中的IMP</span></div><div class="line">method_exchangeImplementations -&gt; method_exchangeImplementations(Method m1, Method m2); <span class="comment">//Returns a string describing a method's parameter and return types.</span></div><div class="line">method_setImplementation -&gt; IMP method_setImplementation(Method m, IMP imp); <span class="comment">// Sets the implementation of a method.</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta"># 关联对象</span></div><div class="line">objc_setAssociatedObject -&gt; objc_setAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">id</span> value, objc_AssociationPolicy policy);<span class="comment">//Sets an associated value for a given object using a given key and association policy.</span></div><div class="line">objc_getAssociatedObject -&gt; <span class="keyword">id</span> objc_getAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key);<span class="comment">// Returns the value associated with a given object for a given key.</span></div><div class="line">objc_removeAssociatedObjects -&gt; objc_removeAssociatedObjects(<span class="keyword">id</span> object);<span class="comment">// 注意:Removes all associations for a given object.</span></div><div class="line"></div><div class="line"><span class="meta"># 类</span></div><div class="line">object_isClass -&gt; <span class="built_in">BOOL</span> object_isClass(<span class="keyword">id</span> obj);<span class="comment">//Returns whether an object is a class object.</span></div><div class="line">object_getClass -&gt; Class object_getClass(<span class="keyword">id</span> obj);<span class="comment">//Returns the class of an object.</span></div><div class="line">object_getClassName -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *object_getClassName(<span class="keyword">id</span> obj);<span class="comment">//Returns the class name of a given object.</span></div><div class="line">object_setClass -&gt; Class object_setClass(<span class="keyword">id</span> obj, Class cls);<span class="comment">//Sets the class of an object.</span></div><div class="line">objc_getMetaClass -&gt; Class objc_getMetaClass(<span class="keyword">const</span> <span class="keyword">char</span> *name);<span class="comment">// 原类</span></div><div class="line"></div><div class="line"><span class="meta"># 实例变量</span></div><div class="line">object_getIvar -&gt; <span class="keyword">id</span> object_getIvar(<span class="keyword">id</span> obj, Ivar ivar);<span class="comment">//Reads the value of an instance variable in an object.</span></div><div class="line">object_setIvar -&gt; object_setIvar(<span class="keyword">id</span> obj, Ivar ivar, <span class="keyword">id</span> value);<span class="comment">//Sets the value of an instance variable in an object.</span></div><div class="line"></div><div class="line"><span class="comment">// Changes the value of an 实例变量 of a 实例</span></div><div class="line">object_getInstanceVariable -&gt; Ivar object_getInstanceVariable(<span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> **outValue)</div><div class="line">object_setInstanceVariable -&gt; Ivar object_setInstanceVariable(<span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> *value);</div><div class="line"></div><div class="line"><span class="meta"># 属性</span></div><div class="line">property_getName -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *property_getName(objc_property_t property) <span class="comment">// 传入上面的数组(指针)获取每个属性的名称</span></div><div class="line">property_getAttributes -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *property_getAttributes(objc_property_t property) <span class="comment">// 返回属性的名称和@encode类型字符串</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta"># 发送消息</span></div><div class="line">objc_msgSend -&gt; objc_msgSend(<span class="keyword">id</span> obj, SEL name);</div></pre></td></tr></table></figure>
<h3 id="获取列表-属性、方法、协议"><a href="#获取列表-属性、方法、协议" class="headerlink" title="获取列表(属性、方法、协议)"></a>获取列表(属性、方法、协议)</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    <span class="comment">//获取属性列表</span></div><div class="line">    objc_property_t *propertyList = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(propertyList[i]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"property----&gt;%@"</span>, [<span class="built_in">NSString</span> stringWithUTF8String:propertyName]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取方法列表</span></div><div class="line">    Method *methodList = class_copyMethodList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i; i&lt;count; i++) &#123;</div><div class="line">        Method method = methodList[i];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"method----&gt;%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(method)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取成员变量列表</span></div><div class="line">    Ivar *ivarList = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i; i&lt;count; i++) &#123;</div><div class="line">        Ivar myIvar = ivarList[i];</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *ivarName = ivar_getName(myIvar);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Ivar----&gt;%@"</span>, [<span class="built_in">NSString</span> stringWithUTF8String:ivarName]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取协议列表</span></div><div class="line">    __<span class="keyword">unsafe_unretained</span> Protocol **protocolList = class_copyProtocolList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i; i&lt;count; i++) &#123;</div><div class="line">        Protocol *myProtocal = protocolList[i];</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *protocolName = protocol_getName(myProtocal);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"protocol----&gt;%@"</span>, [<span class="built_in">NSString</span> stringWithUTF8String:protocolName]);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="相关的定义"><a href="#相关的定义" class="headerlink" title="相关的定义"></a>相关的定义</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 描述类中的一个方法</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_method *Method;</div><div class="line"></div><div class="line"><span class="comment">/// 实例变量</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_ivar *Ivar;</div><div class="line"></div><div class="line"><span class="comment">/// 类别Category</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_category *Category;</div><div class="line"></div><div class="line"><span class="comment">/// 类中声明的属性</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t;</div></pre></td></tr></table></figure>
<h3 id="类在runtime中的表示"><a href="#类在runtime中的表示" class="headerlink" title="类在runtime中的表示"></a>类在runtime中的表示</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_class &#123;</div><div class="line">    Class isa;<span class="comment">//指针，顾名思义，表示是一个什么，</span></div><div class="line">    <span class="comment">//实例的isa指向类对象，类对象的isa指向元类</span></div><div class="line"></div><div class="line"><span class="meta">#if !__OBJC2__</span></div><div class="line">    Class super_class;  <span class="comment">//指向父类</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;  <span class="comment">//类名</span></div><div class="line">    <span class="keyword">long</span> version;</div><div class="line">    <span class="keyword">long</span> info;</div><div class="line">    <span class="keyword">long</span> instance_size</div><div class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars <span class="comment">//成员变量列表</span></div><div class="line">    <span class="keyword">struct</span> objc_method_list **methodLists; <span class="comment">//方法列表</span></div><div class="line">    <span class="keyword">struct</span> objc_cache *cache;<span class="comment">//缓存</span></div><div class="line">    <span class="comment">//一种优化，调用过的方法存入缓存列表，下次调用先找缓存</span></div><div class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols <span class="comment">//协议列表</span></div><div class="line">    <span class="meta">#endif</span></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div><div class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></div></pre></td></tr></table></figure>
<h3 id="方法调用在运行时的过程"><a href="#方法调用在运行时的过程" class="headerlink" title="方法调用在运行时的过程"></a>方法调用在运行时的过程</h3><ul>
<li>如果调用实例方法，会到实例的isa指针指向的对象（也就是类对象）操作。</li>
<li><p>如果调用的是类方法，会到类对象的isa指针指向的对象（也就是元类对象）中操作。</p>
<ol>
<li>在相应操作的对象中的缓存方法列表中找调用的方法，如果找到，转向相应实现并执行。<br></li>
<li>如果没找到，在相应操作的对象中的方法列表中找调用的方法，如果找到，转向相应实现执行<br></li>
<li>如果没找到，去父类指针所指向的对象中执行1，2.<br></li>
<li>以此类推，如果一直到根类还没找到，转向<code>拦截调用</code>。<br></li>
<li>如果没有重写<code>拦截调用</code>的方法，程序报错。<br></li>
</ol>
</li>
</ul>
<h4 id="拦截调用"><a href="#拦截调用" class="headerlink" title="拦截调用"></a>拦截调用</h4><p>拦截调用就是，在找不到调用的方法程序崩溃之前，你有机会通过重写NSObject的四个方法来处理。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span></div><div class="line"><span class="comment">// 动态解析 类方法</span></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel;</div><div class="line"><span class="comment">// 动态解析 实例方法</span></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel;</div><div class="line"> <span class="number">2.</span></div><div class="line"> <span class="comment">// 当某个对象不能接受某个selector时，将对该selector的调用转发给另一个对象</span></div><div class="line"> - (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line"><span class="number">3.</span></div><div class="line"><span class="comment">// 后两个方法需要转发消息到其他类时要同时实现</span></div><div class="line"><span class="comment">//传入参数NSInvocation对象对前一个接口返回的方法对象是有依赖，前一个接口的NSMethodSignature对象返回nil，则消息转发流程即告结束</span></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector</div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation;</div></pre></td></tr></table></figure></p>
<ul>
<li>第一个方法是当你调用一个不存在的类方法的时候，会调用这个方法，默认返回NO，你可以加上自己的处理然后返回YES。</li>
<li>第二个方法和第一个方法相似，只不过处理的是实例方法。</li>
<li>第三个方法是将你调用的不存在的方法重定向到一个其他声明了这个方法的类，只需要你返回一个有这个方法的target。</li>
<li>第四个方法是将你调用的不存在的方法打包成NSInvocation传给你。做完你自己的处理后，调用invokeWithTarget:方法让某个target触发这个方法。</li>
</ul>
<h4 id="动态添加方法"><a href="#动态添加方法" class="headerlink" title="动态添加方法"></a>动态添加方法</h4><p>重写了拦截调用的方法并且返回了YES，我们要怎么处理呢？<br><br>有一个办法是根据传进来的SEL类型的selector动态添加一个方法。</p>
<p>首先从外部隐式调用一个不存在的方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//隐式调用方法</span></div><div class="line">[target performSelector:<span class="keyword">@selector</span>(resolveAdd:) withObject:<span class="string">@"test"</span>];</div></pre></td></tr></table></figure></p>
<p>然后，在target对象内部重写拦截调用的方法，动态添加方法。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> runAddMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span> *string)&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add C IMP "</span>, string);</div><div class="line">&#125;</div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel&#123;</div><div class="line"></div><div class="line">    <span class="comment">//给本类动态添加一个方法</span></div><div class="line">    <span class="keyword">if</span> ([<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@"resolveAdd:"</span>]) &#123;</div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP)runAddMethod, <span class="string">"v@:*"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中class_addMethod的四个参数分别是：<br></p>
<ol>
<li>Class cls 给哪个类添加方法，本例中是self<br></li>
<li>SEL name 添加的方法，本例中是重写的拦截调用传进来的selector。<br></li>
<li>IMP imp 方法的实现，C方法的方法实现可以直接获得。如果是OC方法，可以用<br>+ (IMP)instanceMethodForSelector:(SEL)aSelector;获得方法的实现。<br></li>
<li>“v@:*”方法的签名，代表有一个参数的方法。</li>
</ol>
<h4 id="关联对象"><a href="#关联对象" class="headerlink" title="关联对象"></a>关联对象</h4><p>现在你准备用一个系统的类，但是系统的类并不能满足你的需求，你需要额外添加一个属性。<br><br>这种情况的一般解决办法就是继承。<br><br>但是，只增加一个属性，就去继承一个类，总是觉得太麻烦类。<br><br>这个时候，runtime的关联属性就发挥它的作用了。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//首先定义一个全局变量，用它的地址作为关联对象的key</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> associatedObjectKey;</div><div class="line"><span class="comment">//设置关联对象</span></div><div class="line">objc_setAssociatedObject(target, &amp;associatedObjectKey, <span class="string">@"添加的字符串属性"</span>, OBJC_ASSOCIATION_RETAIN_NONATOMIC); <span class="comment">//获取关联对象</span></div><div class="line"><span class="built_in">NSString</span> *string = objc_getAssociatedObject(target, &amp;associatedObjectKey);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"AssociatedObject = %@"</span>, string);</div></pre></td></tr></table></figure></p>
<p>objc_setAssociatedObject的四个参数：</p>
<ol>
<li>id object给谁设置关联对象。</li>
<li>const void *key关联对象唯一的key，获取时会用到。</li>
<li>id value关联对象。</li>
<li>objc_AssociationPolicy关联策略，有以下几种策略：</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,</div><div class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, </div><div class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,</div><div class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>,</div><div class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span> </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>objc_getAssociatedObject的两个参数。</p>
<ol>
<li>id object获取谁的关联对象。</li>
<li>const void *key根据这个唯一的key获取关联对象。</li>
</ol>
<p>其实，你还可以把添加和获取关联对象的方法写在你需要用到这个功能的类的类别中，方便使用。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//添加关联对象</span></div><div class="line">- (<span class="keyword">void</span>)addAssociatedObject:(<span class="keyword">id</span>)object&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(getAssociatedObject), object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div><div class="line"><span class="comment">//获取关联对象</span></div><div class="line">- (<span class="keyword">id</span>)getAssociatedObject&#123;</div><div class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，-cmd代表当前调用方法的地址。"><a href="#注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，-cmd代表当前调用方法的地址。" class="headerlink" title="注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，_cmd代表当前调用方法的地址。"></a>注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，_cmd代表当前调用方法的地址。</h5><h3 id="方法交换"><a href="#方法交换" class="headerlink" title="方法交换"></a>方法交换</h3><p>方法交换，就是将两个方法的实现交换。例如，将A方法和B方法交换，调用A方法的时候，就会执行B方法中的代码，反之亦然。<br><br>话不多说，这是参考Mattt大神在NSHipster上的文章自己写的代码。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"UIViewController+swizzling.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">swizzling</span>)</span></div><div class="line"></div><div class="line"><span class="comment">//load方法会在类第一次加载的时候被调用</span></div><div class="line"><span class="comment">//调用的时间比较靠前，适合在这个方法里做方法交换</span></div><div class="line">+ (<span class="keyword">void</span>)load&#123;</div><div class="line">    <span class="comment">//方法交换应该被保证，在程序中只会执行一次</span></div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line"></div><div class="line">        <span class="comment">//获得viewController的生命周期方法的selector</span></div><div class="line">        SEL systemSel = <span class="keyword">@selector</span>(viewWillAppear:);</div><div class="line">        <span class="comment">//自己实现的将要被交换的方法的selector</span></div><div class="line">        SEL swizzSel = <span class="keyword">@selector</span>(swiz_viewWillAppear:);</div><div class="line">        <span class="comment">//两个方法的Method</span></div><div class="line">        Method systemMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], systemSel);</div><div class="line">        Method swizzMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], swizzSel);</div><div class="line"></div><div class="line">        <span class="comment">//首先动态添加方法，实现是被交换的方法，返回值表示添加成功还是失败</span></div><div class="line">        <span class="built_in">BOOL</span> isAdd = class_addMethod(<span class="keyword">self</span>, systemSel, method_getImplementation(swizzMethod), method_getTypeEncoding(swizzMethod));</div><div class="line">        <span class="keyword">if</span> (isAdd) &#123;</div><div class="line">            <span class="comment">//如果成功，说明类中不存在这个方法的实现</span></div><div class="line">            <span class="comment">//将被交换方法的实现替换到这个并不存在的实现</span></div><div class="line">            class_replaceMethod(<span class="keyword">self</span>, swizzSel, method_getImplementation(systemMethod), method_getTypeEncoding(systemMethod));</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="comment">//否则，交换两个方法的实现</span></div><div class="line">            method_exchangeImplementations(systemMethod, swizzMethod);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)swiz_viewWillAppear:(<span class="built_in">BOOL</span>)animated&#123;</div><div class="line">    <span class="comment">//这时候调用自己，看起来像是死循环</span></div><div class="line">    <span class="comment">//但是其实自己的实现已经被替换了</span></div><div class="line">    [<span class="keyword">self</span> swiz_viewWillAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"swizzle"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>在一个自己定义的viewController中重写viewWillAppear</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated&#123;</div><div class="line">    [<span class="keyword">super</span> viewWillAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我的理解：</p>
<ul>
<li>方法交换对于我来说更像是实现一种思想的最佳技术：AOP面向切面编程。<br></li>
<li>既然是切面，就一定不要忘记，交换完再调回自己。<br></li>
<li>一定要保证只交换一次，否则就会很乱。<br></li>
<li>最后，据说这个技术很危险，谨慎使用。<br></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/05/2015-05-05-runtime-gai-shu/" data-id="cj11z9je40005uczjaajfcqzl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-04-runtime-dui-xiang-mo-xing" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/04/2015-05-04-runtime-dui-xiang-mo-xing/" class="article-date">
  <time datetime="2015-05-04T10:01:50.000Z" itemprop="datePublished">2015-05-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/04/2015-05-04-runtime-dui-xiang-mo-xing/">Objective-C Runtime(二) 对象模型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Objective-C语言是一门动态语言，它将很多静态语言在编译和链接时期做的事放到了运行时来处理。这种动态语言的优势在于：我们写代码时更具灵活性，如我们可以把消息转发给我们想要的对象，或者随意交换一个方法的实现等。</p>
<p>这种特性意味着Objective-C不仅需要一个编译器，还需要一个运行时系统来执行编译的代码。对于Objective-C来说，这个运行时系统就像一个操作系统一样：它让所有的工作可以正常的运行。这个运行时系统即Objc Runtime。Objc Runtime其实是一个Runtime库，它基本上是用C和汇编写的，这个库使得C语言有了面向对象的能力。</p>
        
          <p class="article-more-link">
            <a href="/2015/05/04/2015-05-04-runtime-dui-xiang-mo-xing/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/04/2015-05-04-runtime-dui-xiang-mo-xing/" data-id="cj11z9je30004uczjmudlk5jr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-03-kvc-he-kvoshen-ru" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/03/2015-05-03-kvc-he-kvoshen-ru/" class="article-date">
  <time datetime="2015-05-03T09:48:00.000Z" itemprop="datePublished">2015-05-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/03/2015-05-03-kvc-he-kvoshen-ru/">KVC 和 KVO深入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h3 id="KVC概述"><a href="#KVC概述" class="headerlink" title="KVC概述"></a>KVC概述</h3><h4 id="1-什么是KVC？"><a href="#1-什么是KVC？" class="headerlink" title="1.什么是KVC？"></a>1.什么是KVC？</h4><p>KVC即NSKeyValueCoding,键/值编码,一个非正式的Protocol,以字符串的形式向对象发送消息，而不是通过调用存取方法，直接或通过实例变量访问的机制。</p>
<p>valueForKey:首先查找以键-key或-isKey命名的getter方法。如果不存在getter方法（假如我们没有通过@synthesize提供存取方法），它将在对象内部查找名为_key或key的实例变量。<br>对于KVC，Cocoa自动放入和取出标量值（int，float和struct）放入NSNumber或NSValue中；当使用-setValue:ForKey:时，它自动将标量值从这些对象中取出。仅KVC具有这种自动包装功能，常规方法调用和属性语法不具备该功能。</p>
<p>-setValue:ForKey:的工作方式和-valueForKey:相同。它首先查找名称的setter方法，如果不存在setter方法，它将在类中查找名为_key或key的实例变量。</p>
<h4 id="2-使用KVC说明"><a href="#2-使用KVC说明" class="headerlink" title="2.使用KVC说明"></a>2.使用KVC说明</h4><ul>
<li>KVC间接修改对象属性时，会自动判断对象属性的类型，完成相应的转换。</li>
<li>KVC按键值路径取值时，如果对象不包含指定的键值，那么就会自动进入对象内部，查找对象属性。</li>
<li>KVC可以嵌套按照键值路径取值。</li>
</ul>
<p>值得注意的是这个不仅可以访问作为对象属性，而且也能访问一些标量（例如 int 和 CGFloat）和 struct（例如 CGRect）<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[object setValue:@(<span class="number">20</span>) forKey:<span class="string">@"height"</span>];</div></pre></td></tr></table></figure></p>
<h4 id="3-KVC和KVO有什么区别？"><a href="#3-KVC和KVO有什么区别？" class="headerlink" title="3.KVC和KVO有什么区别？"></a>3.KVC和KVO有什么区别？</h4><p>KVO是建立在KVC之上的，KVO能够观察一个对象的KVC key-path值的变化。</p>
<hr>
<h3 id="KVO概述"><a href="#KVO概述" class="headerlink" title="KVO概述"></a>KVO概述</h3><h4 id="1-什么是KVO？"><a href="#1-什么是KVO？" class="headerlink" title="1.什么是KVO？"></a>1.什么是KVO？</h4><p>KVO是Key-Value Observing的缩写。KVO是Cocoa提供的一种称为键－值观察的机制，对象可以通过它得到其他对象特性属性的变更通知。这种机制在MVC模式的场景中很重要，因为它让视图对象可以经由控制器层观察模型对象的变更。</p>
<p>这一机制基于NSKeyValueObserving非正式协议，Cocoa通过这个协议为所有遵守协议的对象提供了一种自动化的属性观察能力。要实现自动观察，参与KVO的对象需要符合KVC的要求和存取方法，也可以手动实现观察者通知，也可以两者都保留。</p>
<h4 id="2-KVO的好处"><a href="#2-KVO的好处" class="headerlink" title="2.KVO的好处"></a>2.KVO的好处</h4><ul>
<li>使用KVO最直接的好处就是可以减少代码量。</li>
<li>KVO是观察者设计模式中的一种，有利与业务逻辑于视图控制之间的解耦。</li>
</ul>
<h4 id="3-更深刻的了解KVO，你可以动手写一个小demo思路如下："><a href="#3-更深刻的了解KVO，你可以动手写一个小demo思路如下：" class="headerlink" title="3.更深刻的了解KVO，你可以动手写一个小demo思路如下："></a>3.更深刻的了解KVO，你可以动手写一个小demo思路如下：</h4><ul>
<li>定义一个对象People，分别有name和age属性</li>
<li>监听People的age属性</li>
<li>定义一个UIButton，在button的点击方法里面，去改变People的age。</li>
<li>你就可以收到age改变时发出来的通知</li>
<li>在对象销毁的时候，移除通知。</li>
</ul>
<h4 id="KVO-进阶"><a href="#KVO-进阶" class="headerlink" title="KVO 进阶"></a>KVO 进阶</h4><p>KVO(Key Value Observing)，是观察者模式在Foundation中的实现</p>
<h5 id="KVO-Compliance（KVO兼容）"><a href="#KVO-Compliance（KVO兼容）" class="headerlink" title="KVO Compliance（KVO兼容）"></a>KVO Compliance（KVO兼容）</h5><p>有两种方法可以保证变更通知被发出。自动发送通知是NSObject提供的，并且一个类中的所有属性都默认支持，只要是符合KVO的。一般情况你使用自动变更通知，你不需要写任何代码。<br>人工变更通知需要些额外的代码，但也对通知发送提供了额外的控制。你可以通过重写子类automaticallyNotifiesObserversForKey:方法的方式控制子类一些属性的自动通知。</p>
<ul>
<li>Automatic Change Notification（自动通知）<br>  下面代码中的方法都能导致KVO变更消息发出</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Call the accessor method.</span></div><div class="line">[account setName:<span class="string">@"Savings"</span>];</div><div class="line"> </div><div class="line"><span class="comment">// Use setValue:forKey:.</span></div><div class="line">[account setValue:<span class="string">@"Savings"</span> forKey:<span class="string">@"name"</span>];</div><div class="line"> </div><div class="line"><span class="comment">// Use a key path, where 'account' is a kvc-compliant property of 'document'.</span></div><div class="line">[document setValue:<span class="string">@"Savings"</span> forKeyPath:<span class="string">@"account.name"</span>];</div><div class="line"> </div><div class="line"><span class="comment">// Use mutableArrayValueForKey: to retrieve a relationship proxy object.</span></div><div class="line">Transaction *newTransaction = &lt;<span class="meta">#Create a new transaction for the account#&gt;;</span></div><div class="line"><span class="built_in">NSMutableArray</span> *transactions = [account mutableArrayValueForKey:<span class="string">@"transactions"</span>];</div><div class="line">[transactions addObject:newTransaction];</div></pre></td></tr></table></figure>
<ul>
<li><p>Manual Change Notification（手动通知）</p>
<p>  下面的代码为openingBalance属性开启了人工通知，并让父类决定其他属性的通知方式。</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)theKey &#123;</div><div class="line"> </div><div class="line">    <span class="built_in">BOOL</span> automatic = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">if</span> ([theKey isEqualToString:<span class="string">@"openingBalance"</span>]) &#123;</div><div class="line">        automatic = <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        automatic = [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:theKey];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> automatic;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>要实现人工观察者通知，你要执行在变更前执行willChangeValueForKey:方法，在变更后执行didChangeValueForKey:方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setOpeningBalance:(<span class="keyword">double</span>)theBalance &#123;</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"openingBalance"</span>];</div><div class="line">    _openingBalance = theBalance;</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"openingBalance"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了使不必要的通知最小化我们应该在变更前先检查一下值是否变了：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setOpeningBalance:(<span class="keyword">double</span>)theBalance &#123;</div><div class="line">    <span class="keyword">if</span> (theBalance != _openingBalance) &#123;</div><div class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"openingBalance"</span>];</div><div class="line">        _openingBalance = theBalance;</div><div class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"openingBalance"</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果一个操作导致了多个键的变化，你必须嵌套变更通知：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setOpeningBalance:(<span class="keyword">double</span>)theBalance &#123;</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"openingBalance"</span>];</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"itemChanged"</span>];</div><div class="line">    _openingBalance = theBalance;</div><div class="line">    _itemChanged = _itemChanged+<span class="number">1</span>;</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"itemChanged"</span>];</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"openingBalance"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="KVO的原理"><a href="#KVO的原理" class="headerlink" title="KVO的原理"></a>KVO的原理</h4><p>简而言之就是：</p>
<ul>
<li>当一个object有观察者时，动态创建这个object的类的子类</li>
<li>对于每个被观察的property，重写其set方法</li>
<li>在重写的set方法中调用- willChangeValueForKey:和- didChangeValueForKey:通知观察者</li>
<li>当一个property没有观察者时，删除重写的方法</li>
<li>当没有observer观察任何一个property时，删除动态创建的子类</li>
</ul>
<p>空说无凭，简单验证下。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Sark</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line">Sark *sark = [Sark new];</div><div class="line"><span class="comment">// breakpoint 1</span></div><div class="line">[sark addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"name"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</div><div class="line"><span class="comment">// breakpoint 2</span></div><div class="line">sark.name = <span class="string">@"萨萨萨"</span>;</div><div class="line">[sark removeObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"name"</span>];</div><div class="line"><span class="comment">// breakpoint 3</span></div></pre></td></tr></table></figure></p>
<p>断住后分别使用- class和object_getClass()打出sark对象的Class和真实的Class<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// breakpoint 1</span></div><div class="line">(lldb) po sark.class</div><div class="line">Sark</div><div class="line">(lldb) po object_getClass(sark)</div><div class="line">Sark</div><div class="line"></div><div class="line"><span class="comment">// breakpoint 2</span></div><div class="line">(lldb) po sark.class</div><div class="line">Sark</div><div class="line">(lldb) po object_getClass(sark)</div><div class="line"><span class="built_in">NSKVONotifying_Sark</span></div><div class="line"></div><div class="line"><span class="comment">// breakpoint 3</span></div><div class="line">(lldb) po sark.class</div><div class="line">Sark</div><div class="line">(lldb) po object_getClass(sark)</div><div class="line">Sark</div></pre></td></tr></table></figure></p>
<p>上面的结果说明，在sark对象被观察时,framework使用runtime动态创建了一个Sark类的子类<code>NSKVONotifying_Sark</code>而且为了隐藏这个行为,<code>NSKVONotifying_Sark</code>重写了-class方法返回之前的类,就好像什么也没发生过一样但是使用object_getClass()时就暴露了,因为这个方法返回的是这个对象的<code>isa指针</code>，<code>这个指针指向的一定是个这个对象的类对象</code>.</p>
<p>然后来偷窥一下这个动态类实现的方法，这里请出一个NSObject的扩展NSObject+DLIntrospection，它封装了打印一个类的方法、属性、协议等常用调试方法，一目了然。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">DLIntrospection</span>)</span></div><div class="line">+ (<span class="built_in">NSArray</span> *)classes;</div><div class="line">+ (<span class="built_in">NSArray</span> *)properties;</div><div class="line">+ (<span class="built_in">NSArray</span> *)instanceVariables;</div><div class="line">+ (<span class="built_in">NSArray</span> *)classMethods;</div><div class="line">+ (<span class="built_in">NSArray</span> *)instanceMethods;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSArray</span> *)protocols;</div><div class="line">+ (<span class="built_in">NSDictionary</span> *)descriptionForProtocol:(Protocol *)proto;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSString</span> *)parentClassHierarchy;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>然后继续在刚才的断点处调试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// breakpoint 1</div><div class="line">(lldb) po [object_getClass(sark) instanceMethods]</div><div class="line">&lt;__NSArrayI 0x8e9aa00&gt;(</div><div class="line">- (void)setName:(id)arg0 ,</div><div class="line">- (void).cxx_destruct,</div><div class="line">- (id)name</div><div class="line">)</div><div class="line">// breakpoint 2</div><div class="line">(lldb) po [object_getClass(sark) instanceMethods]</div><div class="line">&lt;__NSArrayI 0x8d55870&gt;(</div><div class="line">- (void)setName:(id)arg0 ,</div><div class="line">- (class)class,</div><div class="line">- (void)dealloc,</div><div class="line">- (BOOL)_isKVOA</div><div class="line">)</div><div class="line">// breakpoint 3</div><div class="line">(lldb) po [object_getClass(sark) instanceMethods]</div><div class="line">&lt;__NSArrayI 0x8e9cff0&gt;(</div><div class="line">- (void)setName:(id)arg0 ,</div><div class="line">- (void).cxx_destruct,</div><div class="line">- (id)name</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>首先就有个扎眼的<code>- .cxx_destruct</code>冒出来，这货是个啥？详细的探 究请参考我的另一篇文章。</p>
<p>大概就是说arc下这个方法在所有dealloc调用完成后负责释放所有的变量，当然这个和kvo没啥关系了，回到正题。<br>从上面breakpoint2的打印可以看出，动态类重写了4个方法：</p>
<ul>
<li><code>- setName:</code>最主要的重写方法，set值时调用通知函数</li>
<li><code>- class</code>隐藏自己必备啊，返回原来类的class</li>
<li><code>- dealloc</code>做清理犯罪现场工作</li>
<li><code>- _isKVOA</code>这就是内部使用的标示了，判断这个类有没被KVO动态生成子类</li>
</ul>
<p>接下来验证一下KVO重写set方法后是否调用了<code>- willChangeValueForKey:</code>和<br><code>- didChangeValueForKey:</code>最直接的验证方法就是在Sark类中重写这两个方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Sark</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)willChangeValueForKey:(<span class="built_in">NSString</span> *)key</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(_cmd));</div><div class="line">    [<span class="keyword">super</span> willChangeValueForKey:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)didChangeValueForKey:(<span class="built_in">NSString</span> *)key</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(_cmd));</div><div class="line">    [<span class="keyword">super</span> didChangeValueForKey:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/03/2015-05-03-kvc-he-kvoshen-ru/" data-id="cj11z9jdt0001uczjpifpzemm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-02-singleton" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/02/2015-05-02-singleton/" class="article-date">
  <time datetime="2015-05-02T10:14:13.000Z" itemprop="datePublished">2015-05-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/02/2015-05-02-singleton/">单例模式的ARC和MRC实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>单例在整个工程中,就相当于一个全局变量,就是不论在哪里需要用到这个类的实例变量,都可以通过单例方法来取得,而且一旦你创建了一个单例类,不论你在多少个界面中初始化调用了这个单例方法取得对象,它们所有的对象都是指向的同一块内存存储空间(即单例类保证了该类的实力对象是唯一存在的一个).</p>
        
          <p class="article-more-link">
            <a href="/2015/05/02/2015-05-02-singleton/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/02/2015-05-02-singleton/" data-id="cj11z9jdm0000uczjbxl39b41" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-01-Swift-ru-men" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/01/2015-05-01-Swift-ru-men/" class="article-date">
  <time datetime="2015-05-01T14:24:06.000Z" itemprop="datePublished">2015-05-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Swift/">Swift</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/01/2015-05-01-Swift-ru-men/">Swift 入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="特色"><a href="#特色" class="headerlink" title="特色"></a>特色</h3><ul>
<li>苹果宣称 Swift 的特点是：快速、现代、安全、互动，而且明显优于 Objective-C 语言</li>
<li>可以使用现有的 <code>Cocoa</code> 和 <code>Cocoa Touch</code> 框架</li>
<li>Swift 取消了 Objective C 的指针及其他不安全访问的使用</li>
<li>舍弃 Objective C 早期应用 <code>Smalltalk</code> 的语法，全面改为句点表示法</li>
<li>提供了类似 Java 的名字空间(namespace)、泛型(generic)、运算对象重载（operator overloading）</li>
<li>Swift 被简单的形容为 “没有 C 的 Objective-C”（Objective-C without the C）</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2015/05/01/2015-05-01-Swift-ru-men/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codershmily.github.io/2015/05/01/2015-05-01-Swift-ru-men/" data-id="cj11z9je00003uczjkaylomwn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Swift/">Swift</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/05/15/2015-05-15-sdwebimageyuan-ma-jie-xi/">SDWebImage源码解析</a>
          </li>
        
          <li>
            <a href="/2015/05/07/2015-05-07-objective-c-runtime-si-dong-tai-fang-fa-jue-yi-dynamic-method-resolution/">Objective-C Runtime(四) 动态方法决议</a>
          </li>
        
          <li>
            <a href="/2015/05/06/2015-05-06-objective-c-runtime-san-xiao-xi-chuan-di/">Objective-C Runtime(三) 消息传递</a>
          </li>
        
          <li>
            <a href="/2015/05/05/2015-05-05-runtime-gai-shu/">Objective-C Runtime(一) 概述</a>
          </li>
        
          <li>
            <a href="/2015/05/04/2015-05-04-runtime-dui-xiang-mo-xing/">Objective-C Runtime(二) 对象模型</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 CoderShmily<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">所有文章</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>