<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Runtime常用方法和一些应用">
<meta property="og:type" content="article">
<meta property="og:title" content="Objective-C Runtime(一) 概述">
<meta property="og:url" content="http://codershmily.github.io/2015/05/05/Objective-C Runtime(一) 概述/index.html">
<meta property="og:site_name" content="CoderShmily's Blog">
<meta property="og:description" content="Runtime常用方法和一些应用">
<meta property="og:updated_time" content="2017-04-03T10:45:48.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Objective-C Runtime(一) 概述">
<meta name="twitter:description" content="Runtime常用方法和一些应用">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://codershmily.github.io/2015/05/05/Objective-C Runtime(一) 概述/"/>





  <title>Objective-C Runtime(一) 概述 | CoderShmily's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CoderShmily's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">总结学习的点点滴滴</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://codershmily.github.io/2015/05/05/Objective-C Runtime(一) 概述/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CoderShmily">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opgilmcn7.bkt.clouddn.com/2017-05-05-100.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoderShmily's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Objective-C Runtime(一) 概述</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-05-05T17:55:39+08:00">
                2015-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Runtime常用方法和一些应用</p>
<a id="more"></a>
<h3 id="Runtime方法列表"><a href="#Runtime方法列表" class="headerlink" title="Runtime方法列表"></a>Runtime方法列表</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># class</span></div><div class="line">class_getInstanceMethod -&gt; Method class_getInstanceMethod(Class cls, SEL name);<span class="comment">// 返回给定类的指定的实例方法</span></div><div class="line">class_addMethod -&gt; <span class="built_in">BOOL</span> class_addMethod(Class cls, SEL name, IMP imp, <span class="keyword">const</span> <span class="keyword">char</span> *types);<span class="comment">// 通过方法名SEL+原来的IMP实现给类添加新方法</span></div><div class="line">class_copyPropertyList -&gt; objc_property_t *class_copyPropertyList(Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount) <span class="comment">// 获取类的属性列表</span></div><div class="line"></div><div class="line"><span class="meta"># method</span></div><div class="line"></div><div class="line">method_getTypeEncoding -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *method_getTypeEncoding(Method m);<span class="comment">// Returns a string describing a method's parameter and return types.</span></div><div class="line">method_getImplementation -&gt; IMP method_getImplementation(Method m);<span class="comment">//获取Method中的IMP</span></div><div class="line">method_exchangeImplementations -&gt; method_exchangeImplementations(Method m1, Method m2); <span class="comment">//Returns a string describing a method's parameter and return types.</span></div><div class="line">method_setImplementation -&gt; IMP method_setImplementation(Method m, IMP imp); <span class="comment">// Sets the implementation of a method.</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta"># 关联对象</span></div><div class="line">objc_setAssociatedObject -&gt; objc_setAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">id</span> value, objc_AssociationPolicy policy);<span class="comment">//Sets an associated value for a given object using a given key and association policy.</span></div><div class="line">objc_getAssociatedObject -&gt; <span class="keyword">id</span> objc_getAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key);<span class="comment">// Returns the value associated with a given object for a given key.</span></div><div class="line">objc_removeAssociatedObjects -&gt; objc_removeAssociatedObjects(<span class="keyword">id</span> object);<span class="comment">// 注意:Removes all associations for a given object.</span></div><div class="line"></div><div class="line"><span class="meta"># 类</span></div><div class="line">object_isClass -&gt; <span class="built_in">BOOL</span> object_isClass(<span class="keyword">id</span> obj);<span class="comment">//Returns whether an object is a class object.</span></div><div class="line">object_getClass -&gt; Class object_getClass(<span class="keyword">id</span> obj);<span class="comment">//Returns the class of an object.</span></div><div class="line">object_getClassName -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *object_getClassName(<span class="keyword">id</span> obj);<span class="comment">//Returns the class name of a given object.</span></div><div class="line">object_setClass -&gt; Class object_setClass(<span class="keyword">id</span> obj, Class cls);<span class="comment">//Sets the class of an object.</span></div><div class="line">objc_getMetaClass -&gt; Class objc_getMetaClass(<span class="keyword">const</span> <span class="keyword">char</span> *name);<span class="comment">// 原类</span></div><div class="line"></div><div class="line"><span class="meta"># 实例变量</span></div><div class="line">object_getIvar -&gt; <span class="keyword">id</span> object_getIvar(<span class="keyword">id</span> obj, Ivar ivar);<span class="comment">//Reads the value of an instance variable in an object.</span></div><div class="line">object_setIvar -&gt; object_setIvar(<span class="keyword">id</span> obj, Ivar ivar, <span class="keyword">id</span> value);<span class="comment">//Sets the value of an instance variable in an object.</span></div><div class="line"></div><div class="line"><span class="comment">// Changes the value of an 实例变量 of a 实例</span></div><div class="line">object_getInstanceVariable -&gt; Ivar object_getInstanceVariable(<span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> **outValue)</div><div class="line">object_setInstanceVariable -&gt; Ivar object_setInstanceVariable(<span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> *value);</div><div class="line"></div><div class="line"><span class="meta"># 属性</span></div><div class="line">property_getName -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *property_getName(objc_property_t property) <span class="comment">// 传入上面的数组(指针)获取每个属性的名称</span></div><div class="line">property_getAttributes -&gt; <span class="keyword">const</span> <span class="keyword">char</span> *property_getAttributes(objc_property_t property) <span class="comment">// 返回属性的名称和@encode类型字符串</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta"># 发送消息</span></div><div class="line">objc_msgSend -&gt; objc_msgSend(<span class="keyword">id</span> obj, SEL name);</div></pre></td></tr></table></figure>
<h3 id="获取列表-属性、方法、协议"><a href="#获取列表-属性、方法、协议" class="headerlink" title="获取列表(属性、方法、协议)"></a>获取列表(属性、方法、协议)</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    <span class="comment">//获取属性列表</span></div><div class="line">    objc_property_t *propertyList = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(propertyList[i]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"property----&gt;%@"</span>, [<span class="built_in">NSString</span> stringWithUTF8String:propertyName]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取方法列表</span></div><div class="line">    Method *methodList = class_copyMethodList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i; i&lt;count; i++) &#123;</div><div class="line">        Method method = methodList[i];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"method----&gt;%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(method)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取成员变量列表</span></div><div class="line">    Ivar *ivarList = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i; i&lt;count; i++) &#123;</div><div class="line">        Ivar myIvar = ivarList[i];</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *ivarName = ivar_getName(myIvar);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Ivar----&gt;%@"</span>, [<span class="built_in">NSString</span> stringWithUTF8String:ivarName]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取协议列表</span></div><div class="line">    __<span class="keyword">unsafe_unretained</span> Protocol **protocolList = class_copyProtocolList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i; i&lt;count; i++) &#123;</div><div class="line">        Protocol *myProtocal = protocolList[i];</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *protocolName = protocol_getName(myProtocal);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"protocol----&gt;%@"</span>, [<span class="built_in">NSString</span> stringWithUTF8String:protocolName]);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="相关的定义"><a href="#相关的定义" class="headerlink" title="相关的定义"></a>相关的定义</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 描述类中的一个方法</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_method *Method;</div><div class="line"></div><div class="line"><span class="comment">/// 实例变量</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_ivar *Ivar;</div><div class="line"></div><div class="line"><span class="comment">/// 类别Category</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_category *Category;</div><div class="line"></div><div class="line"><span class="comment">/// 类中声明的属性</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t;</div></pre></td></tr></table></figure>
<h3 id="类在runtime中的表示"><a href="#类在runtime中的表示" class="headerlink" title="类在runtime中的表示"></a>类在runtime中的表示</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_class &#123;</div><div class="line">    Class isa;<span class="comment">//指针，顾名思义，表示是一个什么，</span></div><div class="line">    <span class="comment">//实例的isa指向类对象，类对象的isa指向元类</span></div><div class="line"></div><div class="line"><span class="meta">#if !__OBJC2__</span></div><div class="line">    Class super_class;  <span class="comment">//指向父类</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;  <span class="comment">//类名</span></div><div class="line">    <span class="keyword">long</span> version;</div><div class="line">    <span class="keyword">long</span> info;</div><div class="line">    <span class="keyword">long</span> instance_size</div><div class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars <span class="comment">//成员变量列表</span></div><div class="line">    <span class="keyword">struct</span> objc_method_list **methodLists; <span class="comment">//方法列表</span></div><div class="line">    <span class="keyword">struct</span> objc_cache *cache;<span class="comment">//缓存</span></div><div class="line">    <span class="comment">//一种优化，调用过的方法存入缓存列表，下次调用先找缓存</span></div><div class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols <span class="comment">//协议列表</span></div><div class="line">    <span class="meta">#endif</span></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div><div class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></div></pre></td></tr></table></figure>
<h3 id="方法调用在运行时的过程"><a href="#方法调用在运行时的过程" class="headerlink" title="方法调用在运行时的过程"></a>方法调用在运行时的过程</h3><ul>
<li>如果调用实例方法，会到实例的isa指针指向的对象（也就是类对象）操作。</li>
<li><p>如果调用的是类方法，会到类对象的isa指针指向的对象（也就是元类对象）中操作。</p>
<ol>
<li>在相应操作的对象中的缓存方法列表中找调用的方法，如果找到，转向相应实现并执行。<br></li>
<li>如果没找到，在相应操作的对象中的方法列表中找调用的方法，如果找到，转向相应实现执行<br></li>
<li>如果没找到，去父类指针所指向的对象中执行1，2.<br></li>
<li>以此类推，如果一直到根类还没找到，转向<code>拦截调用</code>。<br></li>
<li>如果没有重写<code>拦截调用</code>的方法，程序报错。<br></li>
</ol>
</li>
</ul>
<h4 id="拦截调用"><a href="#拦截调用" class="headerlink" title="拦截调用"></a>拦截调用</h4><p>拦截调用就是，在找不到调用的方法程序崩溃之前，你有机会通过重写NSObject的四个方法来处理。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span></div><div class="line"><span class="comment">// 动态解析 类方法</span></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel;</div><div class="line"><span class="comment">// 动态解析 实例方法</span></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel;</div><div class="line"> <span class="number">2.</span></div><div class="line"> <span class="comment">// 当某个对象不能接受某个selector时，将对该selector的调用转发给另一个对象</span></div><div class="line"> - (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line"><span class="number">3.</span></div><div class="line"><span class="comment">// 后两个方法需要转发消息到其他类时要同时实现</span></div><div class="line"><span class="comment">//传入参数NSInvocation对象对前一个接口返回的方法对象是有依赖，前一个接口的NSMethodSignature对象返回nil，则消息转发流程即告结束</span></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector</div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation;</div></pre></td></tr></table></figure></p>
<ul>
<li>第一个方法是当你调用一个不存在的类方法的时候，会调用这个方法，默认返回NO，你可以加上自己的处理然后返回YES。</li>
<li>第二个方法和第一个方法相似，只不过处理的是实例方法。</li>
<li>第三个方法是将你调用的不存在的方法重定向到一个其他声明了这个方法的类，只需要你返回一个有这个方法的target。</li>
<li>第四个方法是将你调用的不存在的方法打包成NSInvocation传给你。做完你自己的处理后，调用invokeWithTarget:方法让某个target触发这个方法。</li>
</ul>
<h4 id="动态添加方法"><a href="#动态添加方法" class="headerlink" title="动态添加方法"></a>动态添加方法</h4><p>重写了拦截调用的方法并且返回了YES，我们要怎么处理呢？<br><br>有一个办法是根据传进来的SEL类型的selector动态添加一个方法。</p>
<p>首先从外部隐式调用一个不存在的方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//隐式调用方法</span></div><div class="line">[target performSelector:<span class="keyword">@selector</span>(resolveAdd:) withObject:<span class="string">@"test"</span>];</div></pre></td></tr></table></figure></p>
<p>然后，在target对象内部重写拦截调用的方法，动态添加方法。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> runAddMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span> *string)&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add C IMP "</span>, string);</div><div class="line">&#125;</div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel&#123;</div><div class="line"></div><div class="line">    <span class="comment">//给本类动态添加一个方法</span></div><div class="line">    <span class="keyword">if</span> ([<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@"resolveAdd:"</span>]) &#123;</div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP)runAddMethod, <span class="string">"v@:*"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中class_addMethod的四个参数分别是：<br></p>
<ol>
<li>Class cls 给哪个类添加方法，本例中是self<br></li>
<li>SEL name 添加的方法，本例中是重写的拦截调用传进来的selector。<br></li>
<li>IMP imp 方法的实现，C方法的方法实现可以直接获得。如果是OC方法，可以用<br>+ (IMP)instanceMethodForSelector:(SEL)aSelector;获得方法的实现。<br></li>
<li>“v@:*”方法的签名，代表有一个参数的方法。</li>
</ol>
<h4 id="关联对象"><a href="#关联对象" class="headerlink" title="关联对象"></a>关联对象</h4><p>现在你准备用一个系统的类，但是系统的类并不能满足你的需求，你需要额外添加一个属性。<br><br>这种情况的一般解决办法就是继承。<br><br>但是，只增加一个属性，就去继承一个类，总是觉得太麻烦类。<br><br>这个时候，runtime的关联属性就发挥它的作用了。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//首先定义一个全局变量，用它的地址作为关联对象的key</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> associatedObjectKey;</div><div class="line"><span class="comment">//设置关联对象</span></div><div class="line">objc_setAssociatedObject(target, &amp;associatedObjectKey, <span class="string">@"添加的字符串属性"</span>, OBJC_ASSOCIATION_RETAIN_NONATOMIC); <span class="comment">//获取关联对象</span></div><div class="line"><span class="built_in">NSString</span> *string = objc_getAssociatedObject(target, &amp;associatedObjectKey);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"AssociatedObject = %@"</span>, string);</div></pre></td></tr></table></figure></p>
<p>objc_setAssociatedObject的四个参数：</p>
<ol>
<li>id object给谁设置关联对象。</li>
<li>const void *key关联对象唯一的key，获取时会用到。</li>
<li>id value关联对象。</li>
<li>objc_AssociationPolicy关联策略，有以下几种策略：</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,</div><div class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, </div><div class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,</div><div class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>,</div><div class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span> </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>objc_getAssociatedObject的两个参数。</p>
<ol>
<li>id object获取谁的关联对象。</li>
<li>const void *key根据这个唯一的key获取关联对象。</li>
</ol>
<p>其实，你还可以把添加和获取关联对象的方法写在你需要用到这个功能的类的类别中，方便使用。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//添加关联对象</span></div><div class="line">- (<span class="keyword">void</span>)addAssociatedObject:(<span class="keyword">id</span>)object&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(getAssociatedObject), object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div><div class="line"><span class="comment">//获取关联对象</span></div><div class="line">- (<span class="keyword">id</span>)getAssociatedObject&#123;</div><div class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，-cmd代表当前调用方法的地址。"><a href="#注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，-cmd代表当前调用方法的地址。" class="headerlink" title="注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，_cmd代表当前调用方法的地址。"></a>注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，_cmd代表当前调用方法的地址。</h5><h3 id="方法交换"><a href="#方法交换" class="headerlink" title="方法交换"></a>方法交换</h3><p>方法交换，就是将两个方法的实现交换。例如，将A方法和B方法交换，调用A方法的时候，就会执行B方法中的代码，反之亦然。<br><br>话不多说，这是参考Mattt大神在NSHipster上的文章自己写的代码。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"UIViewController+swizzling.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">swizzling</span>)</span></div><div class="line"></div><div class="line"><span class="comment">//load方法会在类第一次加载的时候被调用</span></div><div class="line"><span class="comment">//调用的时间比较靠前，适合在这个方法里做方法交换</span></div><div class="line">+ (<span class="keyword">void</span>)load&#123;</div><div class="line">    <span class="comment">//方法交换应该被保证，在程序中只会执行一次</span></div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line"></div><div class="line">        <span class="comment">//获得viewController的生命周期方法的selector</span></div><div class="line">        SEL systemSel = <span class="keyword">@selector</span>(viewWillAppear:);</div><div class="line">        <span class="comment">//自己实现的将要被交换的方法的selector</span></div><div class="line">        SEL swizzSel = <span class="keyword">@selector</span>(swiz_viewWillAppear:);</div><div class="line">        <span class="comment">//两个方法的Method</span></div><div class="line">        Method systemMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], systemSel);</div><div class="line">        Method swizzMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], swizzSel);</div><div class="line"></div><div class="line">        <span class="comment">//首先动态添加方法，实现是被交换的方法，返回值表示添加成功还是失败</span></div><div class="line">        <span class="built_in">BOOL</span> isAdd = class_addMethod(<span class="keyword">self</span>, systemSel, method_getImplementation(swizzMethod), method_getTypeEncoding(swizzMethod));</div><div class="line">        <span class="keyword">if</span> (isAdd) &#123;</div><div class="line">            <span class="comment">//如果成功，说明类中不存在这个方法的实现</span></div><div class="line">            <span class="comment">//将被交换方法的实现替换到这个并不存在的实现</span></div><div class="line">            class_replaceMethod(<span class="keyword">self</span>, swizzSel, method_getImplementation(systemMethod), method_getTypeEncoding(systemMethod));</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="comment">//否则，交换两个方法的实现</span></div><div class="line">            method_exchangeImplementations(systemMethod, swizzMethod);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)swiz_viewWillAppear:(<span class="built_in">BOOL</span>)animated&#123;</div><div class="line">    <span class="comment">//这时候调用自己，看起来像是死循环</span></div><div class="line">    <span class="comment">//但是其实自己的实现已经被替换了</span></div><div class="line">    [<span class="keyword">self</span> swiz_viewWillAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"swizzle"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>在一个自己定义的viewController中重写viewWillAppear</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated&#123;</div><div class="line">    [<span class="keyword">super</span> viewWillAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我的理解：</p>
<ul>
<li>方法交换对于我来说更像是实现一种思想的最佳技术：AOP面向切面编程。<br></li>
<li>既然是切面，就一定不要忘记，交换完再调回自己。<br></li>
<li>一定要保证只交换一次，否则就会很乱。<br></li>
<li>最后，据说这个技术很危险，谨慎使用。<br></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/05/06/Objective-C Runtime(二) 对象模型/" rel="prev" title="Objective-C Runtime(二) 对象模型">
                Objective-C Runtime(二) 对象模型 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://opgilmcn7.bkt.clouddn.com/2017-05-05-100.gif"
               alt="CoderShmily" />
          <p class="site-author-name" itemprop="name">CoderShmily</p>
           
              <p class="site-description motion-element" itemprop="description">╰☆清风徐来，水波不兴☆╮</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Runtime方法列表"><span class="nav-number">1.</span> <span class="nav-text">Runtime方法列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取列表-属性、方法、协议"><span class="nav-number">2.</span> <span class="nav-text">获取列表(属性、方法、协议)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关的定义"><span class="nav-number">3.</span> <span class="nav-text">相关的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类在runtime中的表示"><span class="nav-number">4.</span> <span class="nav-text">类在runtime中的表示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法调用在运行时的过程"><span class="nav-number">5.</span> <span class="nav-text">方法调用在运行时的过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拦截调用"><span class="nav-number">5.1.</span> <span class="nav-text">拦截调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态添加方法"><span class="nav-number">5.2.</span> <span class="nav-text">动态添加方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关联对象"><span class="nav-number">5.3.</span> <span class="nav-text">关联对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，-cmd代表当前调用方法的地址。"><span class="nav-number">5.3.1.</span> <span class="nav-text">注意：这里面我们把getAssociatedObject方法的地址作为唯一的key，_cmd代表当前调用方法的地址。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法交换"><span class="nav-number">6.</span> <span class="nav-text">方法交换</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoderShmily</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
